# Story 4.2: 投票机制

## Status
Approved

## Story
**As a** STAKE 持有者,
**I want** 对提案进行投票,
**so that** 可以表达我的治理意见。

## Acceptance Criteria
1. 支持投票选项 (Yes/No/Abstain/NoWithVeto)
2. 投票权重按质押量计算
3. 投票统计实时展示
4. 投票历史可查询
5. 达到阈值自动执行提案

## Dev Notes

### 投票 Hook

```typescript
// src/hooks/useVote.ts
export function useVote(proposalId: string) {
  const { client, address } = useRiverChain();
  const [voting, setVoting] = useState(false);

  const vote = async (option: 'YES' | 'NO' | 'ABSTAIN' | 'NO_WITH_VETO') => {
    if (!client || !address) return false;

    setVoting(true);
    try {
      const msg = {
        typeUrl: '/cosmos.gov.v1beta1.MsgVote',
        value: {
          proposalId,
          voter: address,
          option: {
            'YES': 1,
            'NO': 3,
            'ABSTAIN': 2,
            'NO_WITH_VETO': 4,
          }[option],
        },
      };

      const result = await client.signAndBroadcast(address, [msg], 'auto');
      return result.code === 0;
    } catch (err) {
      console.error(err);
      return false;
    } finally {
      setVoting(false);
    }
  };

  return { vote, voting };
}

// 投票统计
export function useTallyResult(proposalId: string) {
  const { client } = useRiverChain();
  const [tally, setTally] = useState<any>(null);

  useEffect(() => {
    if (!client) return;

    client.query('/cosmos.gov.v1beta1.Query/TallyResult', {
      proposalId,
    }).then(res => {
      setTally(res.tally);
    });
  }, [client, proposalId]);

  return tally;
}
```

### 投票组件

```typescript
// src/components/governance/VotePanel.tsx
import { useVote, useTallyResult } from '../../hooks/useVote';

export default function VotePanel({ proposalId }: { proposalId: string }) {
  const { vote, voting } = useVote(proposalId);
  const tally = useTallyResult(proposalId);

  const handleVote = async (option: string) => {
    if (confirm(`确认投 ${option} 票?`)) {
      const success = await vote(option as any);
      if (success) alert('投票成功!');
    }
  };

  return (
    <div className="p-6 bg-gray-800 rounded-lg">
      <h3 className="text-xl font-bold mb-4">投票</h3>

      {/* 投票按钮 */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <button
          onClick={() => handleVote('YES')}
          disabled={voting}
          className="py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold"
        >
          赞成 (Yes)
        </button>
        <button
          onClick={() => handleVote('NO')}
          disabled={voting}
          className="py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold"
        >
          反对 (No)
        </button>
        <button
          onClick={() => handleVote('ABSTAIN')}
          disabled={voting}
          className="py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold"
        >
          弃权 (Abstain)
        </button>
        <button
          onClick={() => handleVote('NO_WITH_VETO')}
          disabled={voting}
          className="py-3 bg-orange-600 hover:bg-orange-700 rounded-lg font-semibold"
        >
          强烈反对 (Veto)
        </button>
      </div>

      {/* 投票统计 */}
      {tally && (
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <span>赞成</span>
            <span className="text-green-500">{tally.yes}</span>
          </div>
          <div className="flex items-center justify-between">
            <span>反对</span>
            <span className="text-red-500">{tally.no}</span>
          </div>
          <div className="flex items-center justify-between">
            <span>弃权</span>
            <span className="text-gray-400">{tally.abstain}</span>
          </div>
          <div className="flex items-center justify-between">
            <span>强烈反对</span>
            <span className="text-orange-500">{tally.noWithVeto}</span>
          </div>
        </div>
      )}
    </div>
  );
}
```

[Source: Cosmos SDK Voting]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial creation | Scrum Master Bob |
