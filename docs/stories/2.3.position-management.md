# Story 2.3: 仓位管理

## Status
Approved

## Story
**As a** 交易用户,
**I want** 查看我的仓位并进行平仓操作,
**so that** 可以管理风险并锁定收益。

## Acceptance Criteria
1. 当前仓位列表展示 (多空方向、数量、入场价、未实现盈亏)
2. 未实现盈亏实时计算并着色 (绿色盈利/红色亏损)
3. 保证金率和强平价格计算展示
4. 一键平仓功能 (市价单)
5. 止盈止损设置 (可选)

## Tasks / Subtasks

- [ ] Task 1: 仓位数据订阅 (AC: 1)
  - [ ] usePositions Hook
  - [ ] WebSocket 订阅仓位更新
  - [ ] 仓位数据结构定义

- [ ] Task 2: 盈亏计算 (AC: 2, 3)
  - [ ] 未实现盈亏计算
  - [ ] 保证金率计算
  - [ ] 强平价格计算
  - [ ] 风险等级判断

- [ ] Task 3: 仓位 UI 组件 (AC: 1, 2, 3)
  - [ ] Positions 主组件
  - [ ] PositionRow 行组件
  - [ ] 实时盈亏更新

- [ ] Task 4: 平仓功能 (AC: 4)
  - [ ] 平仓按钮
  - [ ] MsgClosePosition 消息
  - [ ] 平仓确认对话框

- [ ] Task 5: 止盈止损 (AC: 5, 可选)
  - [ ] TPSLModal 组件
  - [ ] 止盈止损设置表单
  - [ ] 条件订单提交

- [ ] Task 6: 集成测试
  - [ ] 仓位展示测试
  - [ ] 平仓流程测试
  - [ ] 盈亏计算准确性测试

## Dev Notes

### 仓位类型定义

```typescript
// src/types/position.ts
export enum PositionSide {
  LONG = 'LONG',   // 多仓
  SHORT = 'SHORT', // 空仓
}

export interface Position {
  market: string;
  side: PositionSide;
  size: string;              // 仓位数量
  entryPrice: string;        // 入场均价
  markPrice: string;         // 标记价格
  liquidationPrice: string;  // 强平价格
  unrealizedPnl: string;     // 未实现盈亏
  realizedPnl: string;       // 已实现盈亏
  margin: string;            // 保证金
  marginRatio: string;       // 保证金率
  leverage: number;          // 杠杆倍数
  updatedAt: number;
}
```

### 仓位 Hook

```typescript
// src/hooks/usePositions.ts
import { useState, useEffect } from 'react';
import { useRiverChain } from '../contexts/RiverChainContext';
import { Position } from '../types/position';
import Decimal from 'decimal.js';

export function usePositions(market?: string) {
  const { address } = useRiverChain();
  const [positions, setPositions] = useState<Position[]>([]);

  useEffect(() => {
    // TODO: WebSocket 订阅仓位更新
    // 模拟数据
    setPositions([
      {
        market: 'BTC-PERP',
        side: 'LONG',
        size: '0.5',
        entryPrice: '49500',
        markPrice: '50000',
        liquidationPrice: '44550',
        unrealizedPnl: '250',
        realizedPnl: '0',
        margin: '2475',
        marginRatio: '0.0495',
        leverage: 10,
        updatedAt: Date.now(),
      },
    ]);
  }, [address, market]);

  // 计算总未实现盈亏
  const totalUnrealizedPnl = positions.reduce(
    (sum, pos) => sum.plus(new Decimal(pos.unrealizedPnl)),
    new Decimal(0)
  ).toString();

  return { positions, totalUnrealizedPnl };
}

// 计算未实现盈亏
export function calculateUnrealizedPnl(
  side: string,
  entryPrice: string,
  markPrice: string,
  size: string
): string {
  const entry = new Decimal(entryPrice);
  const mark = new Decimal(markPrice);
  const sizeDecimal = new Decimal(size);

  if (side === 'LONG') {
    return mark.minus(entry).times(sizeDecimal).toString();
  } else {
    return entry.minus(mark).times(sizeDecimal).toString();
  }
}

// 计算强平价格
export function calculateLiquidationPrice(
  side: string,
  entryPrice: string,
  leverage: number
): string {
  const entry = new Decimal(entryPrice);
  const maintenanceMarginRatio = new Decimal(0.005); // 0.5%

  if (side === 'LONG') {
    return entry.times(
      new Decimal(1).minus(
        new Decimal(1).dividedBy(leverage).minus(maintenanceMarginRatio)
      )
    ).toString();
  } else {
    return entry.times(
      new Decimal(1).plus(
        new Decimal(1).dividedBy(leverage).minus(maintenanceMarginRatio)
      )
    ).toString();
  }
}
```

### Positions 组件

```typescript
// src/components/trading/Positions/Positions.tsx
import { usePositions } from '../../../hooks/usePositions';
import { useClosePosition } from '../../../hooks/useClosePosition';
import PositionRow from './PositionRow';

export default function Positions({ market }: { market?: string }) {
  const { positions, totalUnrealizedPnl } = usePositions(market);
  const { closePosition, isClosing } = useClosePosition();

  if (positions.length === 0) {
    return (
      <div className="p-8 text-center text-gray-400">
        暂无持仓
      </div>
    );
  }

  return (
    <div>
      <div className="flex items-center justify-between p-4 border-b border-gray-800">
        <h3 className="text-lg font-semibold">当前仓位</h3>
        <div className="text-sm">
          总未实现盈亏:
          <span className={parseFloat(totalUnrealizedPnl) >= 0 ? 'text-green-500' : 'text-red-500'}>
            {parseFloat(totalUnrealizedPnl) >= 0 ? '+' : ''}{totalUnrealizedPnl} USDC
          </span>
        </div>
      </div>

      <div className="grid grid-cols-8 gap-2 px-4 py-2 text-sm text-gray-400 border-b border-gray-800">
        <div>市场</div>
        <div>方向</div>
        <div>数量</div>
        <div>入场价</div>
        <div>标记价</div>
        <div>强平价</div>
        <div>未实现盈亏</div>
        <div>操作</div>
      </div>

      {positions.map(pos => (
        <PositionRow
          key={pos.market}
          position={pos}
          onClose={closePosition}
          isClosing={isClosing}
        />
      ))}
    </div>
  );
}
```

### 平仓 Hook

```typescript
// src/hooks/useClosePosition.ts
export function useClosePosition() {
  const { client, address } = useRiverChain();
  const [isClosing, setIsClosing] = useState(false);

  const closePosition = async (market: string) => {
    if (!confirm('确认平仓?')) return;

    setIsClosing(true);
    try {
      const msg = {
        typeUrl: '/riverchain.clob.v1.MsgClosePosition',
        value: { subaccountId: address, market },
      };

      const result = await client.signAndBroadcast(address, [msg], 'auto');
      return result.code === 0;
    } catch (err) {
      console.error(err);
      return false;
    } finally {
      setIsClosing(false);
    }
  };

  return { closePosition, isClosing };
}
```

[Source: dYdX v4 Position Management]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master Bob |

## QA Results
_待填写_
