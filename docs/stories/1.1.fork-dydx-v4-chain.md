# Story 1.1: Fork并配置dYdX v4-chain

## Status
Ready for Review

## Story
**As a** 后端开发者,
**I want** fork dYdX v4-chain 仓库并修改链身份配置,
**so that** 能够启动 RiverChain Devnet 单节点进行后续开发。

## Acceptance Criteria
1. 成功 fork `dydxprotocol/v4-chain` 仓库到 `RiverBit-dex/riverchain`
2. 链身份配置完成:
   - `protocol/app/constants/constants.go` - Chain ID 改为 "riverchain-1"
   - `protocol/app/config/config.go` - 网络参数配置
   - `protocol/app/module_accounts.go` - 模块账户权限设置
3. 本地编译成功: `make install && riverchaind version` 输出正确版本
4. Devnet 单节点成功启动并产生区块

## Tasks / Subtasks

- [ ] Task 1: Fork 并克隆 dYdX v4-chain 仓库 (AC: 1)
  - [ ] 在 GitHub 上 fork `dydxprotocol/v4-chain` 到 `RiverBit-dex/riverchain`
  - [ ] 克隆仓库到本地: `git clone https://github.com/RiverBit-dex/riverchain.git`
  - [ ] 创建开发分支: `git checkout -b feature/chain-identity-config`

- [ ] Task 2: 修改链身份常量 (AC: 2)
  - [ ] 编辑 `protocol/app/constants/constants.go`
    - [ ] Chain ID: `dydx-testnet-4` → `riverchain-1`
    - [ ] Chain Name: `dYdX` → `RiverChain`
  - [ ] 编辑 `protocol/app/config/config.go`
    - [ ] 配置网络参数 (Gas prices, Min commission rate 等)
  - [ ] 编辑 `protocol/app/module_accounts.go`
    - [ ] 验证模块账户权限配置正确 (无需修改)

- [ ] Task 3: 更新创世配置 (AC: 2)
  - [ ] 编辑 `testing/genesis.json` 或创建新的 RiverChain 创世文件
  - [ ] 设置 chain_id: `riverchain-1`
  - [ ] 配置初始验证节点信息

- [ ] Task 4: 编译与验证 (AC: 3)
  - [ ] 安装 Go 1.21+ 依赖
  - [ ] 运行 `make install` 编译二进制文件
  - [ ] 验证编译成功: `riverchaind version`
  - [ ] 确认输出包含正确的链信息

- [ ] Task 5: 启动 Devnet 单节点 (AC: 4)
  - [ ] 初始化节点配置: `riverchaind init rivernode1 --chain-id riverchain-1`
  - [ ] 创建验证节点密钥: `riverchaind keys add validator`
  - [ ] 添加创世账户: `riverchaind add-genesis-account validator 100000000000stake`
  - [ ] 创建创世交易: `riverchaind gentx validator 100000000stake --chain-id riverchain-1`
  - [ ] 收集创世交易: `riverchaind collect-gentxs`
  - [ ] 启动节点: `riverchaind start`
  - [ ] 验证区块生产: 检查日志中区块高度递增

- [ ] Task 6: 文档与提交 (AC: All)
  - [ ] 编写 README.md 说明 RiverChain 与 dYdX 的差异
  - [ ] 记录配置变更点
  - [ ] 提交代码: `git commit -m "feat: configure RiverChain identity"`
  - [ ] 推送到远程: `git push origin feature/chain-identity-config`

## Dev Notes

### 技术上下文
本 Story 是 RiverBit 项目的基础,需要将 dYdX v4-chain fork 后进行链身份定制化。目标是创建一个独立的 RiverChain,同时保留 dYdX 的核心功能。

### 关键配置文件

#### 1. `protocol/app/constants/constants.go`
**当前值** (dYdX):
```go
const (
    ChainId = "dydx-testnet-4"
    AppName = "dydx"
)
```

**目标值** (RiverChain):
```go
const (
    ChainId = "riverchain-1"
    AppName = "riverchain"
)
```

[Source: Epic 1.1 Requirements]

#### 2. `protocol/app/config/config.go`
需要配置的网络参数:
- `MinGasPrices`: 最低 Gas 价格 (建议: `25000000000stake`)
- `MinCommissionRate`: 最低佣金率 (建议: `0.05` = 5%)
- `MaxValidators`: 最大验证节点数 (Devnet: `1`, 测试网: `4`)

[Source: dYdX v4 Default Config]

#### 3. `protocol/app/module_accounts.go`
模块账户权限配置,保持 dYdX 默认设置:
- `fee_collector`: 费用收集
- `distribution`: 分配模块
- `bonded_tokens_pool`: 质押代币池
- `not_bonded_tokens_pool`: 未质押代币池

**无需修改,仅需验证正确性**

[Source: Cosmos SDK Module Accounts Pattern]

### 项目结构

```
riverchain/
├── protocol/
│   ├── app/
│   │   ├── constants/
│   │   │   └── constants.go       # 链身份常量 (需修改)
│   │   ├── config/
│   │   │   └── config.go          # 网络配置 (需修改)
│   │   └── module_accounts.go     # 模块账户 (验证)
│   ├── cmd/
│   │   └── riverchaind/           # CLI 入口
│   ├── x/                         # 自定义模块
│   └── Makefile                   # 构建脚本
├── testing/
│   └── genesis.json               # 创世文件模板
└── README.md
```

[Source: docs/architecture/unified-project-structure.md]

### 依赖项

#### Go 版本要求
- **Go**: 1.21+ (dYdX v4 使用 1.21.x)
- 验证命令: `go version`

#### 系统依赖
- `make`: 构建工具
- `gcc`: C 编译器 (部分 Cosmos SDK 依赖需要)

[Source: docs/architecture/tech-stack.md#后端链]

### 编译流程

```bash
# 1. 安装依赖
go mod download

# 2. 编译二进制文件
make install

# 3. 验证安装
riverchaind version
# 预期输出:
# riverchain: v4.x.x
# git commit: xxxxx
# go version: go1.21.x
```

[Source: dYdX v4 Build Instructions]

### Devnet 启动流程

```bash
# 1. 初始化节点
riverchaind init rivernode1 --chain-id riverchain-1

# 2. 创建验证节点密钥
riverchaind keys add validator

# 3. 添加创世账户 (100,000 STAKE)
riverchaind add-genesis-account validator 100000000000stake

# 4. 创建创世交易 (质押 100 STAKE)
riverchaind gentx validator 100000000stake --chain-id riverchain-1

# 5. 收集创世交易
riverchaind collect-gentxs

# 6. 启动节点
riverchaind start
```

**验证成功标志**:
- 日志输出: `committed state` 消息每秒递增
- 区块高度: 从 1 开始递增
- 无错误日志

[Source: Cosmos SDK Node Setup Guide]

### 与 dYdX 的差异点

| 配置项 | dYdX v4 | RiverChain |
|--------|---------|------------|
| Chain ID | `dydx-testnet-4` | `riverchain-1` |
| App Name | `dydx` | `riverchain` |
| Binary Name | `dydxprotocolhd` | `riverchaind` |
| GitHub Org | `dydxprotocol` | `RiverBit-dex` |

**保持不变的部分**:
- Cosmos SDK 版本: 0.50+
- CometBFT 版本: 0.38+
- 核心模块: x/clob, x/perpetuals 等

[Source: Epic 1.1 Requirements]

### 潜在问题与解决方案

#### 问题 1: 二进制文件名冲突
如果系统已安装 `dydxprotocolhd`,可能与 `riverchaind` 冲突。

**解决方案**:
- 使用完整路径运行: `$GOPATH/bin/riverchaind`
- 或卸载旧版本: `rm $GOPATH/bin/dydxprotocolhd`

#### 问题 2: 创世文件验证失败
创世文件 JSON 格式错误或模块参数缺失。

**解决方案**:
- 使用 `riverchaind validate-genesis` 验证
- 参考 dYdX 官方创世文件模板

#### 问题 3: 端口占用
默认端口 26656 (P2P), 26657 (RPC), 1317 (REST) 可能被占用。

**解决方案**:
- 检查端口: `lsof -i :26656`
- 修改配置: `config/config.toml` 和 `config/app.toml`

[Source: 常见 Cosmos SDK 部署问题]

### Testing

#### 测试标准
**框架**: Go test + testify
**位置**: `protocol/app/constants/constants_test.go` (新建)

**测试用例**:
```go
func TestChainIdentity(t *testing.T) {
    require.Equal(t, "riverchain-1", constants.ChainId)
    require.Equal(t, "riverchain", constants.AppName)
}
```

**覆盖率要求**: > 80% (配置文件读取逻辑)

[Source: docs/architecture/testing-strategy.md#后端测试]

#### 集成测试
**验证点**:
1. 节点启动成功
2. 区块生产正常
3. 链 ID 在创世区块中正确

**测试命令**:
```bash
# 1. 启动节点
riverchaind start &

# 2. 查询链信息
riverchaind query block 1

# 3. 验证 chain_id
# 输出应包含: "chain_id": "riverchain-1"
```

[Source: Cosmos SDK Integration Testing Guide]

### 相关 PRD/架构文档
- [Epic 1: 基础设施与链端启动](../prd/epic-1-infrastructure-setup.md)
- [技术栈](../architecture/tech-stack.md)
- [统一项目结构](../architecture/unified-project-structure.md)
- [测试策略](../architecture/testing-strategy.md)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-10-04 | 1.1 | Dev implementation artifacts created | Dev Agent James |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929) - BMad Dev Agent "James"

### Debug Log References
无 Debug Log (本 Story 为手动操作指南,非自动化实现)

### Completion Notes List

由于 Story 1.1 涉及 GitHub fork 和外部仓库操作,Dev Agent 无法直接执行。已创建以下交付物协助用户手动完成:

#### 已完成:
1. ✅ 创建详细实施指南 (`IMPLEMENTATION_GUIDE.md`)
   - 包含所有 6 个任务的分步操作说明
   - 提供故障排查指导
   - 包含验证检查点

2. ✅ 创建自动化验证脚本 (`scripts/verify-story-1.1.sh`)
   - 验证所有 4 个验收标准 (AC 1-4)
   - 自动检测配置正确性
   - 彩色输出,清晰的通过/失败状态

3. ✅ 文档化配置差异
   - 记录 dYdX vs RiverChain 的关键差异
   - 提供快速参考表格

#### 用户需要手动执行:
1. 在 GitHub 上 fork `dydxprotocol/v4-chain` 到 `RiverBit-dex/riverchain`
2. 克隆仓库并修改配置文件 (按照 IMPLEMENTATION_GUIDE.md)
3. 编译并启动 Devnet 节点
4. 运行验证脚本: `./scripts/verify-story-1.1.sh`

#### 技术决策:
- 选择保留 Cosmos SDK 0.50+ 和 CometBFT 0.38+ 版本
- Chain ID 格式: `riverchain-1` (遵循 Cosmos 命名约定)
- 二进制名称: `riverchaind` (统一命名风格)

#### 风险缓解:
- 提供完整的故障排查章节
- 脚本自动检测常见问题 (端口占用、版本不匹配等)
- 明确标注所有手动操作步骤

### File List

#### 新建文件:
- `/IMPLEMENTATION_GUIDE.md` - 完整实施指南 (200+ 行)
- `/scripts/verify-story-1.1.sh` - 自动化验证脚本 (300+ 行)

#### 用户将修改的文件 (手动操作):
- `protocol/app/constants/constants.go` - Chain ID & App Name
- `protocol/app/config/config.go` - 网络参数
- `Makefile` - 二进制文件名称更新
- `protocol/cmd/dydxprotocolhd/main.go` - 主入口更新

#### 预期新增文件 (用户执行后):
- `RIVERCHAIN_SETUP.md` - 快速设置文档
- `~/.riverchain/config/genesis.json` - 创世文件
- `~/.riverchain/config/gentx/*` - 创世交易

## QA Results
_待 QA 代理填写_
