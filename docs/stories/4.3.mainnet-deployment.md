# Story 4.3: 主网部署准备

## Status
Approved

## Story
**As a** DevOps 工程师,
**I want** 完成主网部署的所有准备工作,
**so that** 可以安全稳定地启动 RiverBit 主网。

## Acceptance Criteria
1. 创世文件配置完成并验证
2. 部署文档完整 (节点配置、网络拓扑)
3. 安全审计清单完成
4. 监控系统配置就绪
5. 应急预案文档完备

## Dev Notes

### 创世文件配置

```json
// genesis.json
{
  "chain_id": "riverchain-1",
  "genesis_time": "2025-10-25T00:00:00Z",
  "app_state": {
    "auth": {
      "accounts": [
        {
          "@type": "/cosmos.auth.v1beta1.BaseAccount",
          "address": "river1...",
          "pub_key": null,
          "account_number": "0",
          "sequence": "0"
        }
      ]
    },
    "bank": {
      "balances": [
        {
          "address": "river1...",
          "coins": [
            { "denom": "stake", "amount": "100000000000" }
          ]
        }
      ]
    },
    "staking": {
      "params": {
        "unbonding_time": "1814400s",
        "max_validators": 100,
        "bond_denom": "stake"
      }
    },
    "gov": {
      "deposit_params": {
        "min_deposit": [
          { "denom": "stake", "amount": "1000000000" }
        ],
        "max_deposit_period": "172800s"
      },
      "voting_params": {
        "voting_period": "604800s"
      },
      "tally_params": {
        "quorum": "0.4",
        "threshold": "0.5",
        "veto_threshold": "0.334"
      }
    },
    "feetiers": {
      "params": {
        "tiers": [
          { "tier": 1, "maker_fee_ppm": -100, "taker_fee_ppm": 500 },
          { "tier": 2, "maker_fee_ppm": -50, "taker_fee_ppm": 400 },
          { "tier": 3, "maker_fee_ppm": 0, "taker_fee_ppm": 300 },
          { "tier": 4, "maker_fee_ppm": 0, "taker_fee_ppm": 200 }
        ]
      }
    },
    "affiliates": {
      "params": {
        "referral_code_length": 8,
        "reward_ratio": "0.10"
      }
    },
    "revshare": {
      "params": {
        "tier_ratios": {
          "1": "0.20",
          "2": "0.10",
          "3": "0.05"
        },
        "settlement_period": "86400s"
      }
    }
  }
}
```

### 部署脚本

```bash
#!/bin/bash
# scripts/deploy-mainnet.sh

set -e

echo "🚀 RiverBit 主网部署脚本"

# 1. 检查环境
echo "检查 Go 版本..."
go version | grep "go1.21" || (echo "需要 Go 1.21+" && exit 1)

# 2. 编译二进制
echo "编译 riverchaind..."
cd protocol
make install

# 3. 初始化节点
echo "初始化节点..."
riverchaind init <moniker> --chain-id riverchain-1

# 4. 复制创世文件
echo "下载创世文件..."
curl -s https://raw.githubusercontent.com/RiverBit-dex/riverchain/main/genesis.json \
  > ~/.riverchain/config/genesis.json

# 5. 配置种子节点
echo "配置种子节点..."
sed -i 's/seeds = ""/seeds = "seed1@ip:26656,seed2@ip:26656"/' \
  ~/.riverchain/config/config.toml

# 6. 配置持久节点
sed -i 's/persistent_peers = ""/persistent_peers = "peer1@ip:26656"/' \
  ~/.riverchain/config/config.toml

# 7. 启动节点
echo "启动节点..."
riverchaind start --home ~/.riverchain
```

### 监控系统配置

```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards

  node-exporter:
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"

volumes:
  prometheus_data:
  grafana_data:
```

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'riverchain'
    static_configs:
      - targets: ['localhost:26660']  # Tendermint metrics

  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
```

### 安全审计清单

```markdown
# 安全审计清单

## 智能合约审计
- [ ] BridgeAdapter.sol 审计完成
  - [ ] 访问控制检查
  - [ ] 重入攻击防护
  - [ ] 整数溢出检查
  - [ ] 事件日志完整性

## 链端代码审计
- [ ] x/affiliates 模块审计
  - [ ] 循环推荐检测
  - [ ] 推荐码唯一性
- [ ] x/revshare 模块审计
  - [ ] 精度计算准确性
  - [ ] 结算逻辑正确性
- [ ] x/bridge 模块审计
  - [ ] 跨链消息验证
  - [ ] 余额一致性

## 密钥管理
- [ ] 验证节点密钥安全存储
- [ ] 多签钱包配置 (2/3)
- [ ] 冷钱包备份

## 网络安全
- [ ] DDoS 防护配置
- [ ] 防火墙规则
- [ ] SSL/TLS 证书

## 数据安全
- [ ] 数据库备份策略 (每日)
- [ ] 链数据快照 (每周)
- [ ] 灾难恢复演练
```

### 应急预案

```markdown
# 应急预案

## 场景 1: 节点宕机
### 症状
- 节点停止出块
- 无法连接 RPC

### 应急步骤
1. 检查节点日志: `journalctl -u riverchain -f`
2. 检查磁盘空间: `df -h`
3. 重启节点: `systemctl restart riverchain`
4. 如无法恢复,从快照恢复

## 场景 2: 链停止
### 症状
- 全网节点停止出块
- 共识失败

### 应急步骤
1. 验证节点投票停止链
2. 定位问题代码/配置
3. 准备修复补丁
4. 协调验证节点升级
5. 重启链

## 场景 3: 安全漏洞
### 症状
- 异常交易
- 资金损失

### 应急步骤
1. 立即暂停受影响模块
2. 通知所有验证节点
3. 启动紧急治理提案
4. 修复漏洞并审计
5. 补偿受影响用户

## 联系方式
- 技术负责人: xxx
- 安全团队: xxx
- 社区管理: xxx
```

### 部署文档

```markdown
# RiverBit 主网部署文档

## 系统要求
- CPU: 4 核
- 内存: 16GB
- 存储: 500GB SSD
- 网络: 100Mbps

## 验证节点配置

### 1. 安装依赖
```bash
# Ubuntu 22.04
sudo apt update
sudo apt install build-essential git jq -y

# 安装 Go 1.21
wget https://go.dev/dl/go1.21.6.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.6.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
```

### 2. 编译节点
```bash
git clone https://github.com/RiverBit-dex/riverchain.git
cd riverchain
make install
```

### 3. 创建服务
```bash
sudo tee /etc/systemd/system/riverchain.service > /dev/null <<EOF
[Unit]
Description=RiverChain Node
After=network.target

[Service]
User=$USER
ExecStart=$(which riverchaind) start
Restart=on-failure
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable riverchain
sudo systemctl start riverchain
```

### 4. 验证
```bash
riverchaind status
# 检查 catching_up: false
```

## 创建验证节点

```bash
# 1. 创建验证节点密钥
riverchaind keys add validator

# 2. 创建验证节点
riverchaind tx staking create-validator \
  --amount=100000000stake \
  --pubkey=$(riverchaind tendermint show-validator) \
  --moniker="MyValidator" \
  --commission-rate="0.10" \
  --commission-max-rate="0.20" \
  --commission-max-change-rate="0.01" \
  --min-self-delegation="1" \
  --from=validator \
  --chain-id=riverchain-1
```

## 监控配置

```bash
# 启动监控
docker-compose -f docker-compose.monitoring.yml up -d

# 访问 Grafana
# http://localhost:3000
# 用户名: admin
# 密码: admin
```
```

[Source: Cosmos SDK Deployment Guide]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial creation | Scrum Master Bob |
