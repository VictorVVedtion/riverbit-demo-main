# Story 2.2: 下单/撤单功能

## Status
Approved

## Story
**As a** 交易用户,
**I want** 下市价单/限价单并管理我的订单,
**so that** 可以开仓、平仓并控制我的交易策略。

## Acceptance Criteria
1. 下单表单支持市价单和限价单
2. 订单签名使用 Keplr/Leap 钱包
3. 订单广播到 RiverChain 并显示状态 (pending/confirmed/failed)
4. 当前订单列表实时更新
5. 支持单个撤单和批量撤单 (一键全撤)

## Tasks / Subtasks

- [ ] Task 1: 下单表单 UI (AC: 1)
  - [ ] OrderForm 主组件
  - [ ] 市价单/限价单切换
  - [ ] 数量和价格输入
  - [ ] 杠杆选择器 (1x-20x)
  - [ ] 手续费和保证金计算预览

- [ ] Task 2: 订单签名与广播 (AC: 2, 3)
  - [ ] 构建 MsgPlaceOrder 消息
  - [ ] Keplr/Leap 签名集成
  - [ ] 广播到 RiverChain
  - [ ] 交易状态跟踪

- [ ] Task 3: 当前订单列表 (AC: 4)
  - [ ] OpenOrders 组件
  - [ ] WebSocket 订阅订单更新
  - [ ] 订单状态展示
  - [ ] 订单详情 Modal

- [ ] Task 4: 撤单功能 (AC: 5)
  - [ ] 单个撤单按钮
  - [ ] 批量撤单按钮
  - [ ] MsgCancelOrder 消息构建
  - [ ] 撤单确认对话框

- [ ] Task 5: 错误处理
  - [ ] 余额不足提示
  - [ ] 价格超出范围提示
  - [ ] 网络错误处理
  - [ ] 签名拒绝处理

- [ ] Task 6: 集成测试
  - [ ] 下单流程测试
  - [ ] 撤单流程测试
  - [ ] 异常场景测试

## Dev Notes

### 项目结构

```
src/
├── components/
│   └── trading/
│       ├── OrderForm/
│       │   ├── OrderForm.tsx
│       │   ├── OrderTypeSelector.tsx
│       │   ├── LeverageSelector.tsx
│       │   └── OrderSummary.tsx
│       ├── OpenOrders/
│       │   ├── OpenOrders.tsx
│       │   ├── OrderRow.tsx
│       │   └── CancelOrderModal.tsx
│       └── ...
├── hooks/
│   ├── usePlaceOrder.ts
│   ├── useCancelOrder.ts
│   └── useOpenOrders.ts
├── utils/
│   └── orderUtils.ts
└── types/
    └── order.ts
```

[Source: docs/architecture/unified-project-structure.md]

### 订单类型定义

```typescript
// src/types/order.ts
export enum OrderType {
  MARKET = 'MARKET',
  LIMIT = 'LIMIT',
}

export enum OrderSide {
  BUY = 'BUY',
  SELL = 'SELL',
}

export enum OrderStatus {
  PENDING = 'PENDING',      // 待确认
  OPEN = 'OPEN',            // 已挂单
  FILLED = 'FILLED',        // 已成交
  PARTIALLY_FILLED = 'PARTIALLY_FILLED',  // 部分成交
  CANCELED = 'CANCELED',    // 已撤销
  FAILED = 'FAILED',        // 失败
}

export interface Order {
  id: string;
  subaccountId: string;
  market: string;
  type: OrderType;
  side: OrderSide;
  price: string;           // 限价单价格 (市价单为 '0')
  size: string;            // 订单数量
  filled: string;          // 已成交数量
  status: OrderStatus;
  createdAt: number;
  updatedAt: number;
  txHash?: string;         // 交易哈希
}

export interface PlaceOrderParams {
  market: string;
  type: OrderType;
  side: OrderSide;
  price: string;
  size: string;
  leverage: number;
}
```

[Source: dYdX v4 Order Types]

### 下单 Hook

```typescript
// src/hooks/usePlaceOrder.ts
import { useState } from 'react';
import { useRiverChain } from '../contexts/RiverChainContext';
import { PlaceOrderParams, Order, OrderStatus } from '../types/order';
import Decimal from 'decimal.js';

export function usePlaceOrder() {
  const { client, address } = useRiverChain();
  const [isPlacing, setIsPlacing] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const placeOrder = async (params: PlaceOrderParams): Promise<Order | null> => {
    if (!client || !address) {
      setError(new Error('Wallet not connected'));
      return null;
    }

    setIsPlacing(true);
    setError(null);

    try {
      // 1. 构建订单消息
      const msg = {
        typeUrl: '/riverchain.clob.v1.MsgPlaceOrder',
        value: {
          subaccountId: address,
          market: params.market,
          side: params.side === 'BUY' ? 1 : 2,  // Proto enum
          orderType: params.type === 'LIMIT' ? 1 : 2,
          price: new Decimal(params.price).times(1e6).toString(), // 转换为链上精度
          size: new Decimal(params.size).times(1e6).toString(),
          timeInForce: 1, // GTC (Good Till Cancel)
          reduceOnly: false,
          postOnly: params.type === 'LIMIT',
        },
      };

      // 2. 签名和广播
      const result = await client.signAndBroadcast(
        address,
        [msg],
        'auto',
        'Place order'
      );

      // 3. 检查交易结果
      if (result.code !== 0) {
        throw new Error(`Transaction failed: ${result.rawLog}`);
      }

      // 4. 从事件中提取订单 ID
      const orderIdEvent = result.events?.find(
        e => e.type === 'order_placed'
      );
      const orderId = orderIdEvent?.attributes.find(
        a => a.key === 'order_id'
      )?.value;

      if (!orderId) {
        throw new Error('Order ID not found in transaction result');
      }

      // 5. 返回订单对象
      const order: Order = {
        id: orderId,
        subaccountId: address,
        market: params.market,
        type: params.type,
        side: params.side,
        price: params.price,
        size: params.size,
        filled: '0',
        status: OrderStatus.OPEN,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        txHash: result.transactionHash,
      };

      return order;
    } catch (err) {
      console.error('Place order error:', err);
      setError(err as Error);
      return null;
    } finally {
      setIsPlacing(false);
    }
  };

  return {
    placeOrder,
    isPlacing,
    error,
  };
}
```

[Source: Cosmos SDK Transaction Pattern]

### 撤单 Hook

```typescript
// src/hooks/useCancelOrder.ts
import { useState } from 'react';
import { useRiverChain } from '../contexts/RiverChainContext';

export function useCancelOrder() {
  const { client, address } = useRiverChain();
  const [isCanceling, setIsCanceling] = useState(false);

  const cancelOrder = async (orderId: string): Promise<boolean> => {
    if (!client || !address) return false;

    setIsCanceling(true);

    try {
      const msg = {
        typeUrl: '/riverchain.clob.v1.MsgCancelOrder',
        value: {
          subaccountId: address,
          orderId,
        },
      };

      const result = await client.signAndBroadcast(
        address,
        [msg],
        'auto',
        'Cancel order'
      );

      return result.code === 0;
    } catch (err) {
      console.error('Cancel order error:', err);
      return false;
    } finally {
      setIsCanceling(false);
    }
  };

  const cancelAllOrders = async (market: string): Promise<boolean> => {
    if (!client || !address) return false;

    setIsCanceling(true);

    try {
      const msg = {
        typeUrl: '/riverchain.clob.v1.MsgCancelAllOrders',
        value: {
          subaccountId: address,
          market,
        },
      };

      const result = await client.signAndBroadcast(
        address,
        [msg],
        'auto',
        'Cancel all orders'
      );

      return result.code === 0;
    } catch (err) {
      console.error('Cancel all orders error:', err);
      return false;
    } finally {
      setIsCanceling(false);
    }
  };

  return {
    cancelOrder,
    cancelAllOrders,
    isCanceling,
  };
}
```

[Source: Story 2.2 Requirements]

### OrderForm 组件

```typescript
// src/components/trading/OrderForm/OrderForm.tsx
import { useState, useMemo } from 'react';
import { usePlaceOrder } from '../../../hooks/usePlaceOrder';
import { useRiverChain } from '../../../contexts/RiverChainContext';
import { OrderType, OrderSide } from '../../../types/order';
import OrderTypeSelector from './OrderTypeSelector';
import LeverageSelector from './LeverageSelector';
import OrderSummary from './OrderSummary';
import Decimal from 'decimal.js';

interface OrderFormProps {
  market: string;
  currentPrice: string;
}

export default function OrderForm({ market, currentPrice }: OrderFormProps) {
  const { balance } = useRiverChain();
  const { placeOrder, isPlacing, error } = usePlaceOrder();

  const [side, setSide] = useState<OrderSide>(OrderSide.BUY);
  const [type, setType] = useState<OrderType>(OrderType.LIMIT);
  const [price, setPrice] = useState(currentPrice);
  const [size, setSize] = useState('');
  const [leverage, setLeverage] = useState(10);

  // 计算订单摘要
  const summary = useMemo(() => {
    if (!size) return null;

    const sizeDecimal = new Decimal(size);
    const priceDecimal = new Decimal(type === OrderType.MARKET ? currentPrice : price);
    const notional = sizeDecimal.times(priceDecimal);
    const margin = notional.dividedBy(leverage);
    const fee = notional.times(side === OrderSide.BUY ? 0.0005 : -0.0001); // Taker 0.05%, Maker -0.01%

    return {
      notional: notional.toString(),
      margin: margin.toString(),
      fee: fee.toString(),
      total: margin.plus(fee).toString(),
    };
  }, [size, price, currentPrice, type, leverage, side]);

  const handleSubmit = async () => {
    if (!size) return;

    const result = await placeOrder({
      market,
      type,
      side,
      price: type === OrderType.MARKET ? '0' : price,
      size,
      leverage,
    });

    if (result) {
      // 清空表单
      setSize('');
      setPrice(currentPrice);
      alert(`订单已提交! Order ID: ${result.id}`);
    }
  };

  // 检查余额是否足够
  const hasEnoughBalance = useMemo(() => {
    if (!balance || !summary) return false;
    return new Decimal(balance).gte(new Decimal(summary.total));
  }, [balance, summary]);

  return (
    <div className="p-4 bg-gray-900 rounded-lg">
      {/* 买卖切换 */}
      <div className="grid grid-cols-2 gap-2 mb-4">
        <button
          onClick={() => setSide(OrderSide.BUY)}
          className={`py-3 rounded font-semibold transition-colors ${
            side === OrderSide.BUY
              ? 'bg-green-600 text-white'
              : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
          }`}
        >
          买入 / 做多
        </button>
        <button
          onClick={() => setSide(OrderSide.SELL)}
          className={`py-3 rounded font-semibold transition-colors ${
            side === OrderSide.SELL
              ? 'bg-red-600 text-white'
              : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
          }`}
        >
          卖出 / 做空
        </button>
      </div>

      {/* 订单类型 */}
      <OrderTypeSelector value={type} onChange={setType} />

      {/* 杠杆 */}
      <LeverageSelector value={leverage} onChange={setLeverage} />

      {/* 价格 (限价单) */}
      {type === OrderType.LIMIT && (
        <div className="mb-4">
          <label className="block text-sm text-gray-400 mb-2">价格 (USDC)</label>
          <input
            type="number"
            value={price}
            onChange={(e) => setPrice(e.target.value)}
            className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
            step="0.01"
          />
        </div>
      )}

      {/* 数量 */}
      <div className="mb-4">
        <label className="block text-sm text-gray-400 mb-2">数量</label>
        <input
          type="number"
          value={size}
          onChange={(e) => setSize(e.target.value)}
          placeholder="0.00"
          className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
          step="0.001"
        />
        <div className="mt-2 flex space-x-2">
          {[25, 50, 75, 100].map(percent => (
            <button
              key={percent}
              onClick={() => {
                if (balance && summary) {
                  const maxSize = new Decimal(balance)
                    .times(leverage)
                    .dividedBy(currentPrice)
                    .times(percent / 100);
                  setSize(maxSize.toFixed(3));
                }
              }}
              className="flex-1 py-1 text-sm bg-gray-800 hover:bg-gray-700 rounded transition-colors"
            >
              {percent}%
            </button>
          ))}
        </div>
      </div>

      {/* 订单摘要 */}
      {summary && <OrderSummary summary={summary} side={side} />}

      {/* 余额不足提示 */}
      {!hasEnoughBalance && summary && (
        <div className="mb-4 p-3 bg-red-900/20 border border-red-500 rounded">
          <p className="text-sm text-red-400">余额不足</p>
        </div>
      )}

      {/* 错误提示 */}
      {error && (
        <div className="mb-4 p-3 bg-red-900/20 border border-red-500 rounded">
          <p className="text-sm text-red-400">{error.message}</p>
        </div>
      )}

      {/* 提交按钮 */}
      <button
        onClick={handleSubmit}
        disabled={isPlacing || !size || !hasEnoughBalance}
        className={`w-full py-3 rounded font-semibold transition-colors ${
          side === OrderSide.BUY
            ? 'bg-green-600 hover:bg-green-700 disabled:bg-gray-700'
            : 'bg-red-600 hover:bg-red-700 disabled:bg-gray-700'
        } disabled:opacity-50 disabled:cursor-not-allowed`}
      >
        {isPlacing
          ? '提交中...'
          : side === OrderSide.BUY
          ? '买入 / 做多'
          : '卖出 / 做空'}
      </button>
    </div>
  );
}
```

[Source: Trading UI Best Practices]

### OpenOrders 组件

```typescript
// src/components/trading/OpenOrders/OpenOrders.tsx
import { useState, useEffect } from 'react';
import { Order } from '../../../types/order';
import { useCancelOrder } from '../../../hooks/useCancelOrder';
import OrderRow from './OrderRow';

interface OpenOrdersProps {
  market: string;
}

export default function OpenOrders({ market }: OpenOrdersProps) {
  const [orders, setOrders] = useState<Order[]>([]);
  const { cancelOrder, cancelAllOrders, isCanceling } = useCancelOrder();

  useEffect(() => {
    // TODO: 从 Indexer 或 WebSocket 获取当前订单
    // 这里使用模拟数据
    setOrders([
      {
        id: 'order-1',
        subaccountId: 'river1abc...',
        market: 'BTC-PERP',
        type: 'LIMIT',
        side: 'BUY',
        price: '49500.00',
        size: '0.5',
        filled: '0',
        status: 'OPEN',
        createdAt: Date.now() - 60000,
        updatedAt: Date.now() - 60000,
      },
    ]);
  }, [market]);

  const handleCancelOrder = async (orderId: string) => {
    const success = await cancelOrder(orderId);
    if (success) {
      setOrders(prev => prev.filter(o => o.id !== orderId));
    }
  };

  const handleCancelAll = async () => {
    if (!confirm('确认撤销所有订单?')) return;

    const success = await cancelAllOrders(market);
    if (success) {
      setOrders([]);
    }
  };

  if (orders.length === 0) {
    return (
      <div className="p-8 text-center text-gray-400">
        暂无挂单
      </div>
    );
  }

  return (
    <div>
      {/* 头部 */}
      <div className="flex items-center justify-between p-4 border-b border-gray-800">
        <h3 className="text-lg font-semibold">当前订单 ({orders.length})</h3>
        <button
          onClick={handleCancelAll}
          disabled={isCanceling}
          className="px-4 py-2 text-sm bg-red-600 hover:bg-red-700 rounded transition-colors disabled:opacity-50"
        >
          {isCanceling ? '撤销中...' : '全部撤销'}
        </button>
      </div>

      {/* 列标题 */}
      <div className="grid grid-cols-7 gap-2 px-4 py-2 text-sm text-gray-400 border-b border-gray-800">
        <div>时间</div>
        <div>市场</div>
        <div>方向</div>
        <div>类型</div>
        <div>价格</div>
        <div>数量</div>
        <div>操作</div>
      </div>

      {/* 订单列表 */}
      {orders.map(order => (
        <OrderRow
          key={order.id}
          order={order}
          onCancel={handleCancelOrder}
        />
      ))}
    </div>
  );
}
```

### OrderRow 组件

```typescript
// src/components/trading/OpenOrders/OrderRow.tsx
import { Order, OrderSide } from '../../../types/order';
import { formatPrice, formatSize } from '../../../utils/orderbookUtils';

interface OrderRowProps {
  order: Order;
  onCancel: (orderId: string) => void;
}

export default function OrderRow({ order, onCancel }: OrderRowProps) {
  const time = new Date(order.createdAt).toLocaleTimeString();

  return (
    <div className="grid grid-cols-7 gap-2 px-4 py-3 hover:bg-gray-800 border-b border-gray-800/50">
      <div className="text-sm text-gray-400">{time}</div>
      <div className="text-sm">{order.market}</div>
      <div className={`text-sm font-semibold ${
        order.side === OrderSide.BUY ? 'text-green-500' : 'text-red-500'
      }`}>
        {order.side === OrderSide.BUY ? '买入' : '卖出'}
      </div>
      <div className="text-sm">{order.type}</div>
      <div className="text-sm">
        {order.type === 'LIMIT' ? formatPrice(order.price) : '市价'}
      </div>
      <div className="text-sm">{formatSize(order.size)}</div>
      <div>
        <button
          onClick={() => onCancel(order.id)}
          className="px-3 py-1 text-sm text-red-400 hover:bg-red-900/20 rounded transition-colors"
        >
          撤销
        </button>
      </div>
    </div>
  );
}
```

[Source: Story 2.2 Requirements]

### Testing

#### 单元测试
```typescript
// src/hooks/__tests__/usePlaceOrder.test.ts
import { renderHook, act } from '@testing-library/react';
import { usePlaceOrder } from '../usePlaceOrder';
import { vi } from 'vitest';

describe('usePlaceOrder', () => {
  it('should place a limit order', async () => {
    const { result } = renderHook(() => usePlaceOrder());

    await act(async () => {
      const order = await result.current.placeOrder({
        market: 'BTC-PERP',
        type: 'LIMIT',
        side: 'BUY',
        price: '50000',
        size: '0.5',
        leverage: 10,
      });

      expect(order).toBeTruthy();
      expect(order?.market).toBe('BTC-PERP');
    });
  });
});
```

#### E2E 测试
```typescript
// e2e/order-placement.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Order Placement', () => {
  test('should place a limit buy order', async ({ page }) => {
    await page.goto('/trade/BTC-PERP');

    // 选择买入
    await page.click('button:has-text("买入 / 做多")');

    // 输入价格和数量
    await page.fill('input[placeholder*="价格"]', '50000');
    await page.fill('input[placeholder*="数量"]', '0.1');

    // 提交订单
    await page.click('button:has-text("买入 / 做多")');

    // 验证订单出现在列表中
    await expect(page.locator('text=BTC-PERP')).toBeVisible();
  });

  test('should cancel an order', async ({ page }) => {
    await page.goto('/trade/BTC-PERP');

    // 找到订单并撤销
    await page.click('button:has-text("撤销")');

    // 验证订单已移除
    // TODO: 添加具体验证
  });
});
```

**覆盖率要求**: > 80%

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-10-04 | 1.1 | Ready for implementation | Dev Agent James |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Artifacts
- 下单 Hook 完整实现
- 撤单 Hook 实现
- 订单表单组件
- 订单列表组件

### File List
- Hook 代码已嵌入文档
- UI 组件实现已提供
- 测试用例示例已包含

## QA Results
_待 QA 代理填写_
