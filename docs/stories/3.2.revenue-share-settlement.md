# Story 3.2: 分润计算与结算

## Status
Approved

## Story
**As a** 推荐人,
**I want** 根据被推荐人交易手续费自动获得分润,
**so that** 可以获得被动收益。

## Acceptance Criteria
1. 根据层级计算分润 (一级 20%, 二级 10%, 三级 5%)
2. 每日 UTC 00:00 自动批量结算
3. 分润记录上链 (x/revshare)
4. 支持查询分润历史
5. 分润金额精确计算,无精度损失

## Dev Notes

### 分润计算 (链端)

```go
// protocol/x/revshare/keeper/revenue.go
package keeper

import (
    sdk "github.com/cosmos/cosmos-sdk/types"
    "github.com/shopspring/decimal"
)

type RevenueTier struct {
    Level int
    Ratio decimal.Decimal
}

var DefaultRevenueTiers = []RevenueTier{
    {Level: 1, Ratio: decimal.NewFromFloat(0.20)},  // 20%
    {Level: 2, Ratio: decimal.NewFromFloat(0.10)},  // 10%
    {Level: 3, Ratio: decimal.NewFromFloat(0.05)},  // 5%
}

func (k Keeper) DistributeRevenue(
    ctx sdk.Context,
    trader string,
    feeAmount sdk.Dec,
) error {
    // 1. 查询推荐链 (最多 3 层)
    referralChain := k.affiliatesKeeper.GetReferralChain(ctx, trader, 3)

    // 2. 计算各层级分润
    for i, referrer := range referralChain {
        tier := DefaultRevenueTiers[i]
        shareAmount := decimal.NewFromBigInt(feeAmount.BigInt(), 0).
            Mul(tier.Ratio).
            Truncate(6) // USDC 6 位小数

        // 3. 累加到待结算余额
        k.AddPendingRevenue(ctx, referrer, shareAmount.String())
    }

    return nil
}

// 每日结算
func (k Keeper) DailySettlement(ctx sdk.Context) error {
    // 遍历所有有待结算余额的用户
    k.IteratePendingRevenue(ctx, func(address string, amount string) bool {
        // 转移到用户余额
        coins := sdk.NewCoins(sdk.NewCoin("usdc", sdk.NewIntFromString(amount)))
        k.bankKeeper.SendCoinsFromModuleToAccount(
            ctx,
            types.ModuleName,
            sdk.AccAddress(address),
            coins,
        )

        // 记录结算历史
        k.RecordSettlement(ctx, address, amount, ctx.BlockTime())

        // 清零待结算余额
        k.ClearPendingRevenue(ctx, address)

        return false // 继续遍历
    })

    return nil
}
```

[Source: Decimal Precision Pattern]

### 前端 Hook

```typescript
// src/hooks/useRevenue.ts
import { useState, useEffect } from 'react';
import { useRiverChain } from '../contexts/RiverChainContext';
import Decimal from 'decimal.js';

interface RevenueData {
  pending: string;         // 待结算
  settled: string;         // 已结算总额
  history: RevenueRecord[];
}

interface RevenueRecord {
  amount: string;
  timestamp: number;
  from: string;  // 来自哪个被推荐人
}

export function useRevenue() {
  const { client, address } = useRiverChain();
  const [revenue, setRevenue] = useState<RevenueData | null>(null);

  useEffect(() => {
    if (!client || !address) return;

    // 查询分润数据
    Promise.all([
      client.query('/riverchain.revshare.v1.Query/PendingRevenue', { address }),
      client.query('/riverchain.revshare.v1.Query/RevenueHistory', { address }),
    ]).then(([pending, history]) => {
      const settled = history.records.reduce(
        (sum: Decimal, r: any) => sum.plus(new Decimal(r.amount)),
        new Decimal(0)
      ).toString();

      setRevenue({
        pending: pending.amount,
        settled,
        history: history.records,
      });
    });
  }, [client, address]);

  return revenue;
}
```

[Source: Story 3.2 Requirements]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial creation | Scrum Master Bob |
