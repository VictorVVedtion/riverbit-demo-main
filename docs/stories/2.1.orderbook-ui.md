# Story 2.1: 订单簿 UI 实现

## Status
Approved

## Story
**As a** 交易用户,
**I want** 实时查看订单簿买卖盘深度和最新成交,
**so that** 可以了解市场深度并做出交易决策。

## Acceptance Criteria
1. WebSocket 订阅订单簿数据,实时更新延迟 < 1s
2. 订单簿展示买卖盘各 20 档深度
3. 最新成交价、24h 涨跌幅、24h 成交量展示
4. 价格聚合功能 (0.01/0.1/1/10)
5. 订单簿渲染性能 < 100ms,支持虚拟滚动

## Tasks / Subtasks

- [ ] Task 1: WebSocket 数据订阅 (AC: 1)
  - [ ] 实现 useOrderbookWebSocket Hook
  - [ ] 处理订单簿增量更新
  - [ ] 实现自动重连逻辑
  - [ ] 错误处理和降级策略

- [ ] Task 2: 订单簿数据处理 (AC: 2, 4)
  - [ ] 实现订单簿数据结构 (bids/asks)
  - [ ] 价格聚合算法
  - [ ] 深度累计计算
  - [ ] 数据去重和排序

- [ ] Task 3: 订单簿 UI 组件 (AC: 2, 5)
  - [ ] OrderBook 主组件
  - [ ] OrderBookRow 行组件
  - [ ] 虚拟滚动优化
  - [ ] 价格精度格式化

- [ ] Task 4: 市场统计展示 (AC: 3)
  - [ ] MarketStats 组件
  - [ ] 24h 数据聚合
  - [ ] 涨跌幅计算和着色
  - [ ] 成交量格式化

- [ ] Task 5: 价格聚合控制 (AC: 4)
  - [ ] TickSizeSelector 组件
  - [ ] 聚合逻辑实现
  - [ ] 用户偏好保存

- [ ] Task 6: 性能优化与测试 (AC: 5)
  - [ ] React.memo 优化
  - [ ] useMemo/useCallback 优化
  - [ ] 性能监控埋点
  - [ ] E2E 测试

## Dev Notes

### 项目结构

```
src/
├── hooks/
│   ├── useOrderbookWebSocket.ts    # WebSocket 订阅
│   └── useOrderbookData.ts         # 数据处理
├── components/
│   └── trading/
│       ├── OrderBook/
│       │   ├── OrderBook.tsx       # 主组件
│       │   ├── OrderBookRow.tsx    # 行组件
│       │   ├── TickSizeSelector.tsx
│       │   └── MarketStats.tsx
│       └── ...
├── utils/
│   ├── orderbookUtils.ts           # 数据处理工具
│   └── priceFormatter.ts           # 价格格式化
└── types/
    └── orderbook.ts                # 类型定义
```

[Source: docs/architecture/unified-project-structure.md]

### 订单簿数据结构

```typescript
// src/types/orderbook.ts
export interface OrderbookLevel {
  price: string;      // 价格 (字符串避免精度问题)
  size: string;       // 数量
  total: string;      // 累计数量
}

export interface Orderbook {
  market: string;     // 市场标识 (如 "BTC-PERP")
  bids: OrderbookLevel[];  // 买盘
  asks: OrderbookLevel[];  // 卖盘
  lastPrice: string;       // 最新成交价
  timestamp: number;       // 更新时间戳
}

export interface MarketStats {
  market: string;
  lastPrice: string;
  priceChange24h: string;      // 24h 价格变化
  priceChangePercent24h: string; // 24h 涨跌幅
  volume24h: string;            // 24h 成交量
  high24h: string;              // 24h 最高价
  low24h: string;               // 24h 最低价
}

export type TickSize = 0.01 | 0.1 | 1 | 10;
```

[Source: dYdX v4 Orderbook Types]

### WebSocket 订阅 Hook

```typescript
// src/hooks/useOrderbookWebSocket.ts
import { useState, useEffect, useRef, useCallback } from 'react';
import { Orderbook } from '../types/orderbook';

const WS_URL = 'ws://localhost:8080/streaming';

interface OrderbookUpdate {
  type: 'snapshot' | 'update';
  market: string;
  bids: [string, string][];  // [price, size]
  asks: [string, string][];
  timestamp: number;
}

export function useOrderbookWebSocket(market: string) {
  const [orderbook, setOrderbook] = useState<Orderbook | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const [error, setError] = useState<Error | null>(null);
  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<NodeJS.Timeout>();

  const connect = useCallback(() => {
    try {
      const ws = new WebSocket(WS_URL);
      wsRef.current = ws;

      ws.onopen = () => {
        console.log('WebSocket connected');
        setIsConnected(true);
        setError(null);

        // 订阅订单簿
        ws.send(JSON.stringify({
          type: 'subscribe',
          channel: 'orderbook',
          market,
        }));
      };

      ws.onmessage = (event) => {
        const data: OrderbookUpdate = JSON.parse(event.data);

        if (data.type === 'snapshot') {
          // 全量数据
          setOrderbook({
            market: data.market,
            bids: data.bids.map(([price, size]) => ({
              price,
              size,
              total: size, // 后续计算累计
            })),
            asks: data.asks.map(([price, size]) => ({
              price,
              size,
              total: size,
            })),
            lastPrice: data.bids[0]?.[0] || '0',
            timestamp: data.timestamp,
          });
        } else {
          // 增量更新
          setOrderbook(prev => {
            if (!prev) return prev;
            return updateOrderbook(prev, data);
          });
        }
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        setError(new Error('WebSocket connection error'));
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        setIsConnected(false);

        // 3 秒后自动重连
        reconnectTimeoutRef.current = setTimeout(() => {
          console.log('Reconnecting...');
          connect();
        }, 3000);
      };
    } catch (err) {
      setError(err as Error);
    }
  }, [market]);

  useEffect(() => {
    connect();

    return () => {
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
      }
      if (wsRef.current) {
        wsRef.current.close();
      }
    };
  }, [connect]);

  return { orderbook, isConnected, error };
}

// 增量更新订单簿
function updateOrderbook(prev: Orderbook, update: OrderbookUpdate): Orderbook {
  const newBids = [...prev.bids];
  const newAsks = [...prev.asks];

  // 更新 bids
  update.bids.forEach(([price, size]) => {
    const index = newBids.findIndex(level => level.price === price);
    if (size === '0') {
      // 删除
      if (index !== -1) newBids.splice(index, 1);
    } else {
      // 更新或插入
      if (index !== -1) {
        newBids[index] = { price, size, total: size };
      } else {
        newBids.push({ price, size, total: size });
        newBids.sort((a, b) => parseFloat(b.price) - parseFloat(a.price)); // 降序
      }
    }
  });

  // 更新 asks (类似逻辑)
  update.asks.forEach(([price, size]) => {
    const index = newAsks.findIndex(level => level.price === price);
    if (size === '0') {
      if (index !== -1) newAsks.splice(index, 1);
    } else {
      if (index !== -1) {
        newAsks[index] = { price, size, total: size };
      } else {
        newAsks.push({ price, size, total: size });
        newAsks.sort((a, b) => parseFloat(a.price) - parseFloat(b.price)); // 升序
      }
    }
  });

  return {
    ...prev,
    bids: newBids,
    asks: newAsks,
    lastPrice: newBids[0]?.price || prev.lastPrice,
    timestamp: update.timestamp,
  };
}
```

[Source: WebSocket Best Practices]

### 价格聚合工具

```typescript
// src/utils/orderbookUtils.ts
import Decimal from 'decimal.js';
import { OrderbookLevel, TickSize } from '../types/orderbook';

export function aggregateOrderbook(
  levels: OrderbookLevel[],
  tickSize: TickSize
): OrderbookLevel[] {
  const aggregated = new Map<string, Decimal>();

  levels.forEach(level => {
    const price = new Decimal(level.price);
    const size = new Decimal(level.size);

    // 价格向下取整到 tickSize
    const aggregatedPrice = price
      .dividedBy(tickSize)
      .floor()
      .times(tickSize)
      .toString();

    const existing = aggregated.get(aggregatedPrice) || new Decimal(0);
    aggregated.set(aggregatedPrice, existing.plus(size));
  });

  // 转换为数组并排序
  return Array.from(aggregated.entries())
    .map(([price, size]) => ({
      price,
      size: size.toString(),
      total: '0', // 后续计算
    }))
    .sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
}

export function calculateTotals(levels: OrderbookLevel[]): OrderbookLevel[] {
  let total = new Decimal(0);

  return levels.map(level => {
    total = total.plus(new Decimal(level.size));
    return {
      ...level,
      total: total.toString(),
    };
  });
}

export function formatPrice(price: string, decimals: number = 2): string {
  return new Decimal(price).toFixed(decimals);
}

export function formatSize(size: string, decimals: number = 4): string {
  return new Decimal(size).toFixed(decimals);
}
```

[Source: Decimal.js Documentation]

### OrderBook 主组件

```typescript
// src/components/trading/OrderBook/OrderBook.tsx
import { useState, useMemo } from 'react';
import { useOrderbookWebSocket } from '../../../hooks/useOrderbookWebSocket';
import { aggregateOrderbook, calculateTotals } from '../../../utils/orderbookUtils';
import OrderBookRow from './OrderBookRow';
import TickSizeSelector from './TickSizeSelector';
import { TickSize } from '../../../types/orderbook';

interface OrderBookProps {
  market: string;
}

export default function OrderBook({ market }: OrderBookProps) {
  const { orderbook, isConnected, error } = useOrderbookWebSocket(market);
  const [tickSize, setTickSize] = useState<TickSize>(0.1);

  // 聚合和计算
  const { bids, asks } = useMemo(() => {
    if (!orderbook) return { bids: [], asks: [] };

    const aggregatedBids = aggregateOrderbook(orderbook.bids, tickSize);
    const aggregatedAsks = aggregateOrderbook(orderbook.asks, tickSize);

    return {
      bids: calculateTotals(aggregatedBids).slice(0, 20),
      asks: calculateTotals(aggregatedAsks).slice(0, 20),
    };
  }, [orderbook, tickSize]);

  if (error) {
    return (
      <div className="p-4 bg-red-900/20 border border-red-500 rounded">
        <p className="text-red-400">订单簿加载失败: {error.message}</p>
      </div>
    );
  }

  if (!orderbook) {
    return (
      <div className="p-4">
        <div className="animate-pulse">加载订单簿...</div>
      </div>
    );
  }

  const maxTotal = Math.max(
    parseFloat(bids[bids.length - 1]?.total || '0'),
    parseFloat(asks[asks.length - 1]?.total || '0')
  );

  return (
    <div className="flex flex-col h-full bg-gray-900">
      {/* 头部 */}
      <div className="flex items-center justify-between p-4 border-b border-gray-800">
        <h3 className="text-lg font-semibold">订单簿</h3>
        <div className="flex items-center space-x-2">
          <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`} />
          <TickSizeSelector value={tickSize} onChange={setTickSize} />
        </div>
      </div>

      {/* 列标题 */}
      <div className="grid grid-cols-3 gap-2 px-4 py-2 text-sm text-gray-400 border-b border-gray-800">
        <div>价格 (USDC)</div>
        <div className="text-right">数量</div>
        <div className="text-right">总计</div>
      </div>

      {/* 卖盘 (倒序) */}
      <div className="flex-1 overflow-y-auto">
        {[...asks].reverse().map((level, index) => (
          <OrderBookRow
            key={`ask-${index}`}
            level={level}
            type="ask"
            maxTotal={maxTotal}
          />
        ))}
      </div>

      {/* 最新成交价 */}
      <div className="px-4 py-3 bg-gray-800">
        <div className="text-2xl font-bold text-green-500">
          {orderbook.lastPrice}
        </div>
        <div className="text-sm text-gray-400">最新成交</div>
      </div>

      {/* 买盘 */}
      <div className="flex-1 overflow-y-auto">
        {bids.map((level, index) => (
          <OrderBookRow
            key={`bid-${index}`}
            level={level}
            type="bid"
            maxTotal={maxTotal}
          />
        ))}
      </div>
    </div>
  );
}
```

[Source: React Performance Optimization]

### OrderBookRow 组件

```typescript
// src/components/trading/OrderBook/OrderBookRow.tsx
import { memo } from 'react';
import { OrderbookLevel } from '../../../types/orderbook';
import { formatPrice, formatSize } from '../../../utils/orderbookUtils';

interface OrderBookRowProps {
  level: OrderbookLevel;
  type: 'bid' | 'ask';
  maxTotal: number;
}

function OrderBookRow({ level, type, maxTotal }: OrderBookRowProps) {
  const percentage = (parseFloat(level.total) / maxTotal) * 100;

  return (
    <div className="relative px-4 py-1 hover:bg-gray-800 cursor-pointer transition-colors">
      {/* 深度背景 */}
      <div
        className={`absolute inset-y-0 right-0 ${
          type === 'bid' ? 'bg-green-500/10' : 'bg-red-500/10'
        }`}
        style={{ width: `${percentage}%` }}
      />

      {/* 数据 */}
      <div className="relative grid grid-cols-3 gap-2 text-sm">
        <div className={type === 'bid' ? 'text-green-500' : 'text-red-500'}>
          {formatPrice(level.price)}
        </div>
        <div className="text-right text-gray-300">
          {formatSize(level.size)}
        </div>
        <div className="text-right text-gray-400">
          {formatSize(level.total)}
        </div>
      </div>
    </div>
  );
}

export default memo(OrderBookRow);
```

[Source: React.memo Documentation]

### TickSizeSelector 组件

```typescript
// src/components/trading/OrderBook/TickSizeSelector.tsx
import { TickSize } from '../../../types/orderbook';

interface TickSizeSelectorProps {
  value: TickSize;
  onChange: (tickSize: TickSize) => void;
}

export default function TickSizeSelector({ value, onChange }: TickSizeSelectorProps) {
  const options: TickSize[] = [0.01, 0.1, 1, 10];

  return (
    <div className="flex items-center space-x-1">
      <span className="text-sm text-gray-400">精度:</span>
      <select
        value={value}
        onChange={(e) => onChange(parseFloat(e.target.value) as TickSize)}
        className="px-2 py-1 text-sm bg-gray-800 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
      >
        {options.map(opt => (
          <option key={opt} value={opt}>
            {opt >= 1 ? opt.toFixed(0) : opt}
          </option>
        ))}
      </select>
    </div>
  );
}
```

### MarketStats 组件

```typescript
// src/components/trading/OrderBook/MarketStats.tsx
import { useEffect, useState } from 'react';
import { MarketStats as MarketStatsType } from '../../../types/orderbook';
import { formatPrice } from '../../../utils/orderbookUtils';

interface MarketStatsProps {
  market: string;
}

export default function MarketStats({ market }: MarketStatsProps) {
  const [stats, setStats] = useState<MarketStatsType | null>(null);

  useEffect(() => {
    // TODO: 从 API 或 WebSocket 获取 24h 统计数据
    // 这里使用模拟数据
    setStats({
      market,
      lastPrice: '50000.00',
      priceChange24h: '1250.50',
      priceChangePercent24h: '2.56',
      volume24h: '125000000',
      high24h: '50500.00',
      low24h: '48500.00',
    });
  }, [market]);

  if (!stats) return null;

  const isPositive = parseFloat(stats.priceChange24h) >= 0;

  return (
    <div className="grid grid-cols-3 gap-4 p-4 bg-gray-800 rounded-lg">
      <div>
        <div className="text-sm text-gray-400">24h 涨跌</div>
        <div className={`text-lg font-semibold ${isPositive ? 'text-green-500' : 'text-red-500'}`}>
          {isPositive ? '+' : ''}{stats.priceChangePercent24h}%
        </div>
      </div>

      <div>
        <div className="text-sm text-gray-400">24h 最高</div>
        <div className="text-lg font-semibold">{formatPrice(stats.high24h)}</div>
      </div>

      <div>
        <div className="text-sm text-gray-400">24h 最低</div>
        <div className="text-lg font-semibold">{formatPrice(stats.low24h)}</div>
      </div>

      <div className="col-span-3">
        <div className="text-sm text-gray-400">24h 成交量 (USDC)</div>
        <div className="text-lg font-semibold">
          {parseFloat(stats.volume24h).toLocaleString()}
        </div>
      </div>
    </div>
  );
}
```

[Source: Story 2.1 Requirements]

### 依赖安装

```json
// package.json
{
  "dependencies": {
    "decimal.js": "^10.4.3"
  }
}
```

```bash
npm install decimal.js
```

### Testing

#### 单元测试
```typescript
// src/utils/__tests__/orderbookUtils.test.ts
import { describe, it, expect } from 'vitest';
import { aggregateOrderbook, calculateTotals } from '../orderbookUtils';

describe('orderbookUtils', () => {
  describe('aggregateOrderbook', () => {
    it('should aggregate prices by tick size', () => {
      const levels = [
        { price: '50000.12', size: '1', total: '0' },
        { price: '50000.25', size: '2', total: '0' },
        { price: '50000.87', size: '1.5', total: '0' },
      ];

      const result = aggregateOrderbook(levels, 1);

      expect(result).toHaveLength(1);
      expect(result[0].price).toBe('50000');
      expect(result[0].size).toBe('4.5');
    });
  });

  describe('calculateTotals', () => {
    it('should calculate cumulative totals', () => {
      const levels = [
        { price: '50000', size: '1', total: '0' },
        { price: '49999', size: '2', total: '0' },
        { price: '49998', size: '1.5', total: '0' },
      ];

      const result = calculateTotals(levels);

      expect(result[0].total).toBe('1');
      expect(result[1].total).toBe('3');
      expect(result[2].total).toBe('4.5');
    });
  });
});
```

#### E2E 测试
```typescript
// e2e/orderbook.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Orderbook', () => {
  test('should display orderbook with real-time updates', async ({ page }) => {
    await page.goto('/trade/BTC-PERP');

    // 等待订单簿加载
    await page.waitForSelector('[data-testid="orderbook"]');

    // 验证买卖盘存在
    const bids = page.locator('[data-testid="orderbook-bid"]');
    const asks = page.locator('[data-testid="orderbook-ask"]');

    await expect(bids.first()).toBeVisible();
    await expect(asks.first()).toBeVisible();
  });

  test('should change tick size', async ({ page }) => {
    await page.goto('/trade/BTC-PERP');

    const tickSizeSelector = page.locator('[data-testid="tick-size-selector"]');
    await tickSizeSelector.selectOption('1');

    // 验证价格聚合生效
    // TODO: 添加具体验证逻辑
  });
});
```

**覆盖率要求**: > 80%

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-10-04 | 1.1 | Ready for implementation | Dev Agent James |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Artifacts
- WebSocket Hook 完整实现
- 订单簿组件库
- 价格聚合算法
- 性能优化方案

### File List
- Hook 和工具函数代码已嵌入文档
- UI 组件实现已提供
- 测试用例示例已包含

## QA Results
_待 QA 代理填写_
