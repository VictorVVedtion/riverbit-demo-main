# Story 1.3: 业务流模块参数占位

## Status
Approved

## Story
**As a** 链端开发者,
**I want** 配置费率层级、推荐分润、账户认证等业务流模块的基础参数,
**so that** 后续能实现完整的推荐系统和分润机制。

## Acceptance Criteria
1. `x/feetiers` 模块: 费率层级参数草案 (Maker/Taker 费率)
2. `x/affiliates` & `x/revshare` 模块: 推荐码与分润比例占位
3. `x/accountplus` 模块: 认证器组合与限流策略占位
4. 创建治理提案模板 (JSON 格式)
5. 参数可通过 CLI 查询验证

## Tasks / Subtasks

- [ ] Task 1: 配置 x/feetiers 费率层级 (AC: 1)
  - [ ] 定义费率层级结构 (4 个层级)
  - [ ] 设置 Maker 费率 (-0.01% ~ 0.05%)
  - [ ] 设置 Taker 费率 (0.02% ~ 0.10%)
  - [ ] 配置交易量阈值

- [ ] Task 2: 配置 x/affiliates 推荐系统 (AC: 2)
  - [ ] 定义推荐码生成规则
  - [ ] 设置推荐关系存储结构
  - [ ] 配置推荐奖励比例 (10%-30%)

- [ ] Task 3: 配置 x/revshare 分润机制 (AC: 2)
  - [ ] 定义分润计算公式
  - [ ] 设置分润比例参数
  - [ ] 配置结算周期 (每日/每周)

- [ ] Task 4: 配置 x/accountplus 认证器 (AC: 3)
  - [ ] 定义认证器组合规则
  - [ ] 设置限流策略参数
  - [ ] 配置账户权限等级

- [ ] Task 5: 创建治理提案模板 (AC: 4)
  - [ ] 费率调整提案模板
  - [ ] 分润比例调整提案模板
  - [ ] 参数修改提案模板

- [ ] Task 6: CLI 查询验证 (AC: 5)
  - [ ] 实现查询命令
  - [ ] 验证参数可读取
  - [ ] 测试治理提案流程

## Dev Notes

### 模块配置概览

#### x/feetiers (费率层级)
```go
// 费率层级定义
type FeeTier struct {
    Tier          uint32
    MakerFeePpm   int32   // 以 ppm 为单位 (parts per million)
    TakerFeePpm   int32
    VolumeThreshold sdk.Dec
}

// 默认配置
var DefaultFeeTiers = []FeeTier{
    {Tier: 1, MakerFeePpm: -100,  TakerFeePpm: 500,  VolumeThreshold: 0},        // -0.01%, 0.05%
    {Tier: 2, MakerFeePpm: -50,   TakerFeePpm: 400,  VolumeThreshold: 1000000},  // -0.005%, 0.04%, >$1M
    {Tier: 3, MakerFeePpm: 0,     TakerFeePpm: 300,  VolumeThreshold: 10000000}, // 0%, 0.03%, >$10M
    {Tier: 4, MakerFeePpm: 0,     TakerFeePpm: 200,  VolumeThreshold: 50000000}, // 0%, 0.02%, >$50M
}
```

[Source: dYdX v4 Fee Tiers Configuration]

#### x/affiliates (推荐系统)
```go
type AffiliateParams struct {
    ReferralCodeLength     uint32        // 推荐码长度 (8)
    RewardRatio            sdk.Dec       // 推荐奖励比例 (0.1 = 10%)
    RefereeDiscountRatio   sdk.Dec       // 被推荐人折扣 (0.05 = 5%)
    MinTradingVolume       sdk.Dec       // 最小交易量要求
}

// 默认配置
var DefaultAffiliateParams = AffiliateParams{
    ReferralCodeLength:   8,
    RewardRatio:          sdk.NewDecWithPrec(10, 2),  // 10%
    RefereeDiscountRatio: sdk.NewDecWithPrec(5, 2),   // 5%
    MinTradingVolume:     sdk.NewDec(1000),           // $1000
}
```

[Source: RiverBit PRD - 推荐页业务流]

#### x/revshare (分润机制)
```go
type RevenueShareParams struct {
    TierRatios         map[uint32]sdk.Dec  // 层级分润比例
    SettlementPeriod   time.Duration       // 结算周期
    MinClaimAmount     sdk.Dec             // 最小提取金额
}

// 默认配置
var DefaultRevShareParams = RevenueShareParams{
    TierRatios: map[uint32]sdk.Dec{
        1: sdk.NewDecWithPrec(20, 2),  // 20% (一级推荐)
        2: sdk.NewDecWithPrec(10, 2),  // 10% (二级推荐)
        3: sdk.NewDecWithPrec(5, 2),   // 5%  (三级推荐)
    },
    SettlementPeriod: 24 * time.Hour,  // 每日结算
    MinClaimAmount:   sdk.NewDec(10),  // 最小 $10 USDC
}
```

[Source: Epic 1 Requirements]

#### x/accountplus (账户认证)
```go
type AccountPlusParams struct {
    MaxAuthenticators     uint32
    RateLimitPerAddress   uint32  // 每地址限流
    TimestampValidityWindow time.Duration
}

// 默认配置
var DefaultAccountPlusParams = AccountPlusParams{
    MaxAuthenticators:       3,
    RateLimitPerAddress:     100,  // 每分钟 100 次
    TimestampValidityWindow: 60 * time.Second,
}
```

[Source: Cosmos SDK Account Module Pattern]

### 实现路径

```
riverchain/protocol/x/
├── feetiers/
│   ├── types/
│   │   └── params.go          # 费率参数定义
│   ├── keeper/
│   │   └── params.go          # 参数读写
│   └── genesis.go             # 创世配置
├── affiliates/
│   ├── types/
│   │   ├── params.go
│   │   └── affiliate.go       # 推荐关系
│   └── keeper/
│       └── referral.go        # 推荐逻辑
├── revshare/
│   ├── types/
│   │   └── params.go
│   └── keeper/
│       └── revenue.go         # 分润计算
└── accountplus/
    ├── types/
    │   └── params.go
    └── keeper/
        └── authenticator.go
```

[Source: docs/architecture/unified-project-structure.md]

### 治理提案模板

#### 费率调整提案
```json
{
  "@type": "/riverchain.feetiers.MsgUpdateFeeTiers",
  "authority": "river10d07y265gmmuvt4z0w9aw880jnsr700j6z2zm3",
  "fee_tiers": [
    {
      "tier": 1,
      "maker_fee_ppm": -100,
      "taker_fee_ppm": 500,
      "volume_threshold": "0"
    }
  ]
}
```

#### 分润比例调整提案
```json
{
  "@type": "/riverchain.revshare.MsgUpdateParams",
  "authority": "river10d07y265gmmuvt4z0w9aw880jnsr700j6z2zm3",
  "params": {
    "tier_ratios": {
      "1": "0.20",
      "2": "0.10",
      "3": "0.05"
    },
    "settlement_period": "86400s",
    "min_claim_amount": "10"
  }
}
```

[Source: Cosmos SDK Governance Proposal Format]

### CLI 命令

#### 查询命令
```bash
# 查询费率层级
riverchaind query feetiers params

# 查询推荐参数
riverchaind query affiliates params

# 查询分润参数
riverchaind query revshare params

# 查询账户认证参数
riverchaind query accountplus params
```

#### 提交治理提案
```bash
# 提交费率调整提案
riverchaind tx gov submit-proposal fee-tier-update.json \
  --from validator \
  --chain-id riverchain-1

# 投票
riverchaind tx gov vote 1 yes \
  --from validator \
  --chain-id riverchain-1
```

[Source: Cosmos SDK CLI Documentation]

### Testing

#### 单元测试
```go
// x/feetiers/keeper/params_test.go
func TestFeeTierParams(t *testing.T) {
    keeper, ctx := setupKeeper(t)

    params := types.DefaultFeeTiers
    keeper.SetParams(ctx, params)

    retrieved := keeper.GetParams(ctx)
    require.Equal(t, params, retrieved)
}
```

#### 集成测试
```bash
# 测试参数查询
riverchaind query feetiers params | jq '.fee_tiers[0].maker_fee_ppm'
# 预期: -100

# 测试治理提案
riverchaind tx gov submit-proposal test-proposal.json --from validator
riverchaind query gov proposal 1
```

**覆盖率要求**: > 80%

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-10-04 | 1.1 | Ready for implementation | Dev Agent James |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Plan
已创建配置参数模板和 CLI 命令示例,用户需在 riverchain 仓库实现模块参数配置。

### File List
- 配置模板已嵌入 Story 文档
- 治理提案 JSON 模板已提供
- CLI 命令示例已文档化

## QA Results
_待 QA 代理填写_
