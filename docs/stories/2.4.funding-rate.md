# Story 2.4: 资金费率计算

## Status
Approved

## Story
**As a** 交易用户,
**I want** 查看当前资金费率和下次结算时间,
**so that** 可以了解持仓成本并做出交易决策。

## Acceptance Criteria
1. 实时展示当前资金费率 (正/负)
2. 下次结算时间倒计时
3. 资金费率历史记录展示 (图表)
4. 预计资金费用计算 (基于当前仓位)
5. 资金费率支付/收取记录

## Tasks / Subtasks

- [ ] Task 1: 资金费率数据 (AC: 1, 2)
  - [ ] useFundingRate Hook
  - [ ] WebSocket 订阅资金费率更新
  - [ ] 结算倒计时逻辑

- [ ] Task 2: 资金费率 UI (AC: 1, 2, 4)
  - [ ] FundingRate 组件
  - [ ] 费率展示和着色
  - [ ] 倒计时显示
  - [ ] 预计费用计算

- [ ] Task 3: 历史记录 (AC: 3, 5)
  - [ ] FundingHistory 组件
  - [ ] 历史费率图表
  - [ ] 支付记录列表

- [ ] Task 4: 集成测试
  - [ ] 费率计算准确性
  - [ ] 倒计时功能
  - [ ] 历史数据展示

## Dev Notes

### 资金费率类型

```typescript
// src/types/funding.ts
export interface FundingRate {
  market: string;
  rate: string;              // 当前费率 (如 0.0001 = 0.01%)
  nextFundingTime: number;   // 下次结算时间戳
  estimatedRate: string;     // 预估费率
}

export interface FundingPayment {
  market: string;
  rate: string;
  amount: string;            // 支付金额 (正=支付,负=收取)
  timestamp: number;
}
```

### 资金费率 Hook

```typescript
// src/hooks/useFundingRate.ts
import { useState, useEffect } from 'react';
import { FundingRate } from '../types/funding';

export function useFundingRate(market: string) {
  const [fundingRate, setFundingRate] = useState<FundingRate | null>(null);
  const [timeToFunding, setTimeToFunding] = useState(0);

  useEffect(() => {
    // TODO: WebSocket 订阅
    // 模拟数据
    setFundingRate({
      market,
      rate: '0.0001',  // 0.01%
      nextFundingTime: Date.now() + 3600000,  // 1 小时后
      estimatedRate: '0.00015',
    });
  }, [market]);

  // 倒计时
  useEffect(() => {
    if (!fundingRate) return;

    const timer = setInterval(() => {
      const remaining = fundingRate.nextFundingTime - Date.now();
      setTimeToFunding(Math.max(0, remaining));
    }, 1000);

    return () => clearInterval(timer);
  }, [fundingRate]);

  return { fundingRate, timeToFunding };
}

// 计算资金费用
export function calculateFundingFee(
  positionSize: string,
  markPrice: string,
  fundingRate: string
): string {
  return new Decimal(positionSize)
    .times(markPrice)
    .times(fundingRate)
    .toString();
}
```

### FundingRate 组件

```typescript
// src/components/trading/FundingRate/FundingRate.tsx
import { useFundingRate } from '../../../hooks/useFundingRate';
import { usePositions } from '../../../hooks/usePositions';
import { calculateFundingFee } from '../../../hooks/useFundingRate';

export default function FundingRate({ market }: { market: string }) {
  const { fundingRate, timeToFunding } = useFundingRate(market);
  const { positions } = usePositions(market);

  if (!fundingRate) return null;

  const position = positions[0];
  const estimatedFee = position
    ? calculateFundingFee(position.size, position.markPrice, fundingRate.rate)
    : '0';

  const hours = Math.floor(timeToFunding / 3600000);
  const minutes = Math.floor((timeToFunding % 3600000) / 60000);
  const seconds = Math.floor((timeToFunding % 60000) / 1000);

  const ratePercent = (parseFloat(fundingRate.rate) * 100).toFixed(4);
  const isPositive = parseFloat(fundingRate.rate) >= 0;

  return (
    <div className="p-4 bg-gray-800 rounded-lg">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <div className="text-sm text-gray-400">资金费率</div>
          <div className={`text-xl font-bold ${isPositive ? 'text-green-500' : 'text-red-500'}`}>
            {isPositive ? '+' : ''}{ratePercent}%
          </div>
        </div>

        <div>
          <div className="text-sm text-gray-400">下次结算</div>
          <div className="text-xl font-bold">
            {hours.toString().padStart(2, '0')}:
            {minutes.toString().padStart(2, '0')}:
            {seconds.toString().padStart(2, '0')}
          </div>
        </div>

        {position && (
          <div className="col-span-2">
            <div className="text-sm text-gray-400">预计费用</div>
            <div className={`text-lg font-semibold ${
              parseFloat(estimatedFee) >= 0 ? 'text-red-500' : 'text-green-500'
            }`}>
              {parseFloat(estimatedFee) >= 0 ? '-' : '+'}{Math.abs(parseFloat(estimatedFee)).toFixed(2)} USDC
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
```

[Source: dYdX v4 Funding Rate Mechanism]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master Bob |

## QA Results
_待填写_
