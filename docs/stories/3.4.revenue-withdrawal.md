# Story 3.4: 分润提取

## Status
Approved

## Story
**As a** 推荐人,
**I want** 提取我的分润收益到主账户,
**so that** 可以自由使用收益。

## Acceptance Criteria
1. 显示可提取余额 (已结算 - 已提取)
2. 提取功能,最小金额 10 USDC
3. 提取记录上链
4. 提取历史展示
5. 提取手续费展示 (如有)

## Dev Notes

### 提取消息 (链端)

```go
// protocol/x/revshare/keeper/msg_server.go
func (k msgServer) WithdrawRevenue(
    goCtx context.Context,
    msg *types.MsgWithdrawRevenue,
) (*types.MsgWithdrawRevenueResponse, error) {
    ctx := sdk.UnwrapSDKContext(goCtx)

    // 1. 验证提取金额
    amount := sdk.NewIntFromString(msg.Amount)
    minAmount := sdk.NewInt(10_000_000) // 10 USDC (6 decimals)

    if amount.LT(minAmount) {
        return nil, types.ErrAmountTooSmall
    }

    // 2. 检查余额
    balance := k.GetSettledBalance(ctx, msg.Address)
    if balance.LT(amount) {
        return nil, types.ErrInsufficientBalance
    }

    // 3. 转账
    coins := sdk.NewCoins(sdk.NewCoin("usdc", amount))
    err := k.bankKeeper.SendCoinsFromModuleToAccount(
        ctx,
        types.ModuleName,
        sdk.AccAddress(msg.Address),
        coins,
    )
    if err != nil {
        return nil, err
    }

    // 4. 更新余额
    k.DeductSettledBalance(ctx, msg.Address, amount)

    // 5. 记录提取
    k.RecordWithdrawal(ctx, msg.Address, amount.String(), ctx.BlockTime())

    return &types.MsgWithdrawRevenueResponse{Success: true}, nil
}
```

### 提取组件

```typescript
// src/components/referral/WithdrawRevenue.tsx
import { useState } from 'react';
import { useRevenue } from '../../hooks/useRevenue';
import { useRiverChain } from '../../contexts/RiverChainContext';

export default function WithdrawRevenue() {
  const revenue = useRevenue();
  const { client, address } = useRiverChain();
  const [amount, setAmount] = useState('');
  const [isWithdrawing, setIsWithdrawing] = useState(false);

  const handleWithdraw = async () => {
    if (!client || !address) return;

    setIsWithdrawing(true);
    try {
      const msg = {
        typeUrl: '/riverchain.revshare.v1.MsgWithdrawRevenue',
        value: {
          address,
          amount: new Decimal(amount).times(1e6).toString(),
        },
      };

      const result = await client.signAndBroadcast(address, [msg], 'auto');

      if (result.code === 0) {
        alert('提取成功!');
        setAmount('');
      }
    } catch (err) {
      console.error(err);
      alert('提取失败');
    } finally {
      setIsWithdrawing(false);
    }
  };

  const availableBalance = revenue?.settled || '0';
  const minAmount = 10;

  return (
    <div className="p-6 bg-gray-800 rounded-lg">
      <h3 className="text-xl font-bold mb-4">提取收益</h3>

      <div className="mb-4">
        <label className="block text-sm text-gray-400 mb-2">
          可提取余额: {availableBalance} USDC
        </label>
        <input
          type="number"
          value={amount}
          onChange={(e) => setAmount(e.target.value)}
          placeholder={`最小 ${minAmount} USDC`}
          className="w-full px-4 py-3 bg-gray-900 rounded-lg"
        />
      </div>

      <button
        onClick={handleWithdraw}
        disabled={
          isWithdrawing ||
          !amount ||
          parseFloat(amount) < minAmount ||
          parseFloat(amount) > parseFloat(availableBalance)
        }
        className="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold disabled:opacity-50"
      >
        {isWithdrawing ? '提取中...' : '提取到主账户'}
      </button>
    </div>
  );
}
```

[Source: Withdrawal Pattern]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial creation | Scrum Master Bob |
