# RiverBit 架构文档

**版本**: v4
**状态**: Active
**最后更新**: 2025-10-04

## 架构概览

RiverBit 是一个基于 dYdX v4 技术栈的去中心化衍生品交易平台,采用前后端分离架构,支持加密永续合约和代币化美股交易。

## 架构文档列表

### 核心架构
1. [技术栈](./tech-stack.md) - 完整技术选型
2. [项目结构](./unified-project-structure.md) - 源码目录组织
3. [编码标准](./coding-standards.md) - 代码规范与最佳实践
4. [测试策略](./testing-strategy.md) - 测试框架与覆盖率要求

### 后端架构
5. [后端架构](./backend-architecture.md) - 链端模块设计
6. [数据模型](./data-models.md) - 链上数据结构
7. [数据库设计](./database-schema.md) - Indexer PostgreSQL schema
8. [REST API 规范](./rest-api-spec.md) - HTTP 接口定义
9. [外部 API 集成](./external-apis.md) - 价格源等第三方服务

### 前端架构
10. [前端架构](./frontend-architecture.md) - React 应用设计
11. [组件库](./components.md) - UI 组件规范
12. [核心工作流](./core-workflows.md) - 用户交互流程

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Web App   │  │   Keplr     │  │  MetaMask   │         │
│  │ (React 19)  │  │   Wallet    │  │   Wallet    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ├── HTTPS/WSS
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      前端应用层                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  RiverBit Frontend (Vite + TypeScript)               │   │
│  │  ├── Trading Page (订单簿、下单、仓位)                 │   │
│  │  ├── Assets Page (资产、入出金)                       │   │
│  │  ├── Referral Page (推荐、分润)                       │   │
│  │  └── lib/                                            │   │
│  │      ├── riverchain/ (Cosmos 客户端)                  │   │
│  │      └── arbitrum/ (EVM 客户端)                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ├── gRPC/REST + WebSocket
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据服务层                              │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │  Full Node      │  │    Indexer      │                   │
│  │  Streaming      │  │  (PostgreSQL)   │                   │
│  │  (WebSocket)    │  │  ├── Orders     │                   │
│  │                 │  │  ├── Trades     │                   │
│  │                 │  │  └── Positions  │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      区块链层                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  RiverChain (Cosmos SDK + CometBFT)                  │   │
│  │  ├── x/clob (订单簿、撮合引擎)                         │   │
│  │  ├── x/perpetuals (永续合约、资金费)                   │   │
│  │  ├── x/assets (资产管理)                              │   │
│  │  ├── x/prices (价格预言机)                            │   │
│  │  ├── x/affiliates (推荐系统)                          │   │
│  │  ├── x/revshare (分润)                               │   │
│  │  └── x/accountplus (账户认证)                         │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    外部服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Slinky VE  │  │  Polygon.io │  │  Arbitrum   │         │
│  │ (价格预言机) │  │  (美股价格)  │  │  Testnet    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 关键技术决策

### 1. 链端选型: dYdX v4 Fork
**理由**:
- 成熟的永续合约撮合引擎
- 完整的资金费率机制
- 经过生产环境验证

**定制化**:
- 链身份改为 RiverChain
- 业务流模块 (推荐、分润) 参数化
- 支持代币化美股市场

### 2. 前端框架: React 19 + Vite
**理由**:
- 现有 RiverBit UI 组件基于 React
- Vite 提供快速开发体验
- TypeScript 保证类型安全

### 3. 跨链方案: 最小 EVM 适配器
**理由**:
- 阶段一仅需测试网占位
- 避免复杂的桥接协议
- 后端服务桥接,非生产桥

### 4. 数据流: Streaming + Indexer
**理由**:
- Streaming 提供实时订单簿
- Indexer 提供历史数据查询
- 解耦链端与前端数据需求

## 非功能性需求

### 性能指标
- 下单延迟: p95 < 1s (本地 Devnet)
- Streaming 延迟: < 3s
- 价格新鲜度: > 99%, < 2s
- Indexer 查询延迟: < 500ms

### 可用性
- Devnet 稳定运行时间: > 99%
- 前端响应时间: < 2s (LCP)

### 安全性
- 钱包私钥本地存储
- HTTPS/WSS 加密传输
- 合约权限最小化

## 部署架构

### 开发环境 (Devnet)
- 单节点 RiverChain
- 本地 PostgreSQL
- 本地前端开发服务器 (Vite)

### 测试环境 (阶段一目标)
- RiverChain Devnet (4 验证节点)
- Arbitrum Sepolia 测试网
- PostgreSQL (主从)
- Prometheus + Grafana 监控
- Vercel 前端托管

## 下一步

1. 完成各模块详细架构设计文档
2. 定义 API 规范与数据模型
3. 制定代码审查流程
