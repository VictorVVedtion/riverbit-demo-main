# Epic 2: 核心交易功能 (Week 2)

## Epic 概述

**Epic ID**: 2
**Epic 名称**: 核心交易功能
**预计工期**: Week 2 (5-8 天开发时间)
**优先级**: 高
**依赖**: Epic 1 (基础设施与链端启动)

## Epic 目标

实现 RiverBit DEX 的核心交易功能,包括实时订单簿、下单/撤单、仓位管理、资金费率计算等,为用户提供完整的永续合约交易体验。

## 业务价值

- **用户价值**: 可以进行真实的永续合约交易
- **产品价值**: 完成 MVP 核心功能
- **技术价值**: 验证 dYdX v4 架构在 RiverBit 的适配性

## Stories 列表

### Story 2.1: 订单簿 UI 实现
**描述**: 实现实时订单簿 UI,展示买卖盘深度、最新成交价、24h 统计等
**估时**: 1-2 天
**验收标准**:
- WebSocket 订阅订单簿数据
- 实时更新买卖盘深度
- 显示最新成交价和 24h 统计
- 价格聚合功能 (0.01/0.1/1/10)

### Story 2.2: 下单/撤单功能
**描述**: 实现下单表单、订单提交、订单管理和撤单功能
**估时**: 2-3 天
**验收标准**:
- 市价单/限价单表单
- 订单签名和广播
- 当前订单列表展示
- 一键撤单功能
- 批量撤单功能

### Story 2.3: 仓位管理
**描述**: 实现仓位信息展示、止盈止损、仓位平仓功能
**估时**: 1-2 天
**验收标准**:
- 当前仓位列表
- 未实现盈亏计算
- 已实现盈亏计算
- 一键平仓功能
- 止盈止损设置

### Story 2.4: 资金费率计算
**描述**: 实现资金费率计算、展示和结算逻辑
**估时**: 1-2 天
**验收标准**:
- 资金费率实时计算
- 资金费率历史记录
- 下次结算时间倒计时
- 资金费率支付/收取记录

### Story 2.5: 风险控制 (可选)
**描述**: 实现基础风险控制,包括保证金率监控、强平预警
**估时**: 1 天
**验收标准**:
- 保证金率实时计算
- 强平价格计算和展示
- 风险等级提示 (安全/警告/危险)

## 技术要点

### 前端技术栈
- **WebSocket**: 实时数据订阅 (订单簿、成交、仓位更新)
- **React Query**: 服务端状态管理
- **Zustand**: 客户端状态管理
- **Decimal.js**: 精确数值计算

### 链端技术栈
- **x/clob**: 订单簿模块 (Order Placement, Matching, Cancellation)
- **x/perpetuals**: 永续合约模块 (Position Management, Funding Rate)
- **x/prices**: 价格预言机模块 (Oracle Price Feed)

### 关键集成点
1. **订单簿数据流**: Streaming Manager → WebSocket → Frontend
2. **订单提交流程**: Frontend → Cosmos Signer → RiverChain → Order Matching
3. **仓位更新流程**: Order Matched → Position Updated → Frontend Notification
4. **资金费率结算**: Funding Rate Module → Position Settlement → Balance Update

## 数据流图

```
┌─────────────┐
│   用户操作   │
└──────┬──────┘
       │
       ▼
┌─────────────────┐     ┌─────────────────┐
│   交易 UI       │────►│  Cosmos Signer  │
│  (React)        │     │  (Keplr/Leap)   │
└─────────────────┘     └────────┬────────┘
       ▲                         │
       │                         ▼
       │                ┌─────────────────┐
       │                │   RiverChain    │
       │                │   (x/clob)      │
       │                └────────┬────────┘
       │                         │
       │                         ▼
       │                ┌─────────────────┐
       │                │  Order Matching │
       │                │   Engine        │
       │                └────────┬────────┘
       │                         │
       │                         ▼
┌──────┴──────┐         ┌─────────────────┐
│  WebSocket  │◄────────│    Streaming    │
│   Updates   │         │    Manager      │
└─────────────┘         └─────────────────┘
```

## 风险与缓解措施

### 技术风险
1. **WebSocket 连接稳定性**
   - 风险: 网络波动导致数据丢失
   - 缓解: 实现自动重连和数据补偿机制

2. **订单簿性能**
   - 风险: 高频更新导致 UI 卡顿
   - 缓解: 使用虚拟滚动和节流优化

3. **精度计算错误**
   - 风险: JavaScript 浮点数精度问题
   - 缓解: 使用 Decimal.js 进行所有金额计算

### 业务风险
1. **订单匹配延迟**
   - 风险: 链上确认时间影响用户体验
   - 缓解: 展示订单状态 (pending/confirmed)

2. **资金费率波动**
   - 风险: 突然变化导致用户损失
   - 缓解: 提前预警和费率历史展示

## 验收标准

### 功能完整性
- [ ] 订单簿实时更新,延迟 < 1s
- [ ] 下单成功率 > 95%
- [ ] 仓位信息准确率 100%
- [ ] 资金费率计算准确

### 性能指标
- [ ] 订单簿渲染时间 < 100ms
- [ ] 下单响应时间 < 500ms
- [ ] WebSocket 重连时间 < 3s

### 用户体验
- [ ] UI 响应流畅,无明显卡顿
- [ ] 错误提示清晰明确
- [ ] 关键操作有二次确认

## 测试策略

### 单元测试
- 订单簿数据处理逻辑
- 精度计算函数
- 仓位盈亏计算

### 集成测试
- 下单→匹配→成交完整流程
- 资金费率计算和结算
- WebSocket 数据订阅

### E2E 测试
- 完整交易场景 (开仓→平仓)
- 异常场景处理 (网络中断、订单失败)

**测试覆盖率要求**: > 80%

## 里程碑

| 里程碑 | 完成标志 | 预计日期 |
|--------|---------|----------|
| M1: 订单簿可用 | Story 2.1 完成 | Day 2 |
| M2: 下单功能可用 | Story 2.2 完成 | Day 5 |
| M3: 仓位管理可用 | Story 2.3 完成 | Day 6 |
| M4: 资金费率可用 | Story 2.4 完成 | Day 7 |
| M5: Epic 2 完成 | 所有 Story 完成 | Day 8 |

## 下一步 (Epic 3)

Epic 2 完成后,将进入:
- **Epic 3: 推荐与分润系统** (Week 3)
- 实现推荐码生成、关系绑定、分润计算和结算

---

**Epic Owner**: Scrum Master Bob
**技术负责人**: Dev Agent James
**创建日期**: 2025-10-04
**目标完成日期**: 2025-10-11
