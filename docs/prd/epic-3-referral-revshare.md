# Epic 3: 推荐与分润系统 (Week 3)

## Epic 概述

**Epic ID**: 3
**Epic 名称**: 推荐与分润系统
**预计工期**: Week 3 (4-6 天开发时间)
**优先级**: 高
**依赖**: Epic 1 (基础设施), Epic 2 (核心交易)

## Epic 目标

实现 RiverBit 的推荐系统和分润机制,通过推荐码邀请新用户,并根据推荐层级分配交易手续费收益,激励用户增长和社区建设。

## 业务价值

- **用户价值**: 通过推荐获得被动收益
- **产品价值**: 病毒式增长和用户留存
- **商业价值**: 降低获客成本,提升平台交易量

## Stories 列表

### Story 3.1: 推荐码生成与绑定
**描述**: 用户生成专属推荐码,新用户通过推荐码注册并建立推荐关系
**估时**: 1-2 天
**验收标准**:
- 用户可生成唯一推荐码 (8 位字母数字)
- 新用户通过推荐码 URL 注册
- 推荐关系写入链上 (x/affiliates)
- 支持查询推荐关系树 (最多 3 层)

### Story 3.2: 分润计算与结算
**描述**: 根据被推荐人交易手续费计算分润,每日自动结算到推荐人账户
**估时**: 2-3 天
**验收标准**:
- 根据层级计算分润比例 (一级 20%, 二级 10%, 三级 5%)
- 每日 UTC 00:00 自动结算
- 分润记录上链 (x/revshare)
- 分润历史可查询

### Story 3.3: 推荐页 UI
**描述**: 推荐页展示推荐码、邀请链接、推荐人数、累计收益等
**估时**: 1-2 天
**验收标准**:
- 推荐码展示与复制
- 邀请链接生成与分享
- 推荐人数统计 (直接/间接)
- 累计收益展示
- 收益明细列表

### Story 3.4: 分润提取
**描述**: 用户可将分润收益提取到主账户余额
**估时**: 1 天
**验收标准**:
- 显示可提取余额
- 提取功能 (最小 10 USDC)
- 提取记录上链
- 提取历史展示

## 技术要点

### 链端模块
- **x/affiliates**: 推荐关系管理
  - 推荐码生成和验证
  - 推荐关系存储和查询
  - 防止循环推荐

- **x/revshare**: 分润机制
  - 分润比例配置 (已在 Epic 1 完成)
  - 分润计算逻辑
  - 每日自动结算
  - 提取功能

### 前端功能
- 推荐码管理
- 邀请链接生成
- 推荐树可视化
- 收益仪表盘

## 推荐关系架构

```
用户 A (推荐人)
    ↓ 推荐码: ABCD1234
用户 B (一级被推荐人)
    ↓ 推荐码: EFGH5678
用户 C (二级被推荐人)
    ↓ 推荐码: IJKL9012
用户 D (三级被推荐人)

分润比例:
- 用户 D 交易手续费: 100 USDC
- 用户 C 获得: 5 USDC (5%)
- 用户 B 获得: 10 USDC (10%)
- 用户 A 获得: 20 USDC (20%)
- 平台留存: 65 USDC
```

## 分润计算流程

```
1. 用户交易 → 产生手续费
2. 查询推荐关系链 (最多 3 层)
3. 计算各层级分润金额
4. 累加到待结算余额
5. 每日 UTC 00:00 批量结算
6. 更新用户分润余额
7. 发送结算通知
```

## 风险与缓解措施

### 技术风险
1. **循环推荐检测**
   - 风险: 用户互相推荐形成环
   - 缓解: 链上验证推荐关系,禁止循环

2. **分润计算准确性**
   - 风险: 精度问题导致分润错误
   - 缓解: 使用 Decimal 库精确计算

3. **结算性能**
   - 风险: 大量用户导致结算延迟
   - 缓解: 批量处理,异步结算

### 业务风险
1. **推荐码滥用**
   - 风险: 刷单获取分润
   - 缓解: 最小交易量限制

2. **分润成本过高**
   - 风险: 分润比例过高影响收入
   - 缓解: 动态调整比例,治理提案

## 验收标准

### 功能完整性
- [ ] 推荐码生成和验证
- [ ] 推荐关系准确绑定
- [ ] 分润计算准确率 100%
- [ ] 每日自动结算成功
- [ ] 提取功能正常

### 性能指标
- [ ] 推荐码生成 < 100ms
- [ ] 关系查询 < 500ms
- [ ] 结算处理 < 10s (1000 用户)

### 用户体验
- [ ] 推荐码一键复制
- [ ] 邀请链接自动生成
- [ ] 收益实时更新
- [ ] 明细展示清晰

## 测试策略

### 单元测试
- 推荐码唯一性验证
- 分润计算逻辑
- 循环推荐检测
- 提取金额验证

### 集成测试
- 推荐关系建立流程
- 分润结算流程
- 提取到账流程

### E2E 测试
- 完整推荐流程 (注册→交易→分润→提取)
- 多层级推荐场景
- 异常场景处理

**测试覆盖率要求**: > 80%

## 里程碑

| 里程碑 | 完成标志 | 预计日期 |
|--------|---------|----------|
| M1: 推荐功能可用 | Story 3.1 完成 | Day 2 |
| M2: 分润计算可用 | Story 3.2 完成 | Day 5 |
| M3: 推荐页可用 | Story 3.3 完成 | Day 6 |
| M4: Epic 3 完成 | 所有 Story 完成 | Day 7 |

## 下一步 (Epic 4)

Epic 3 完成后,将进入:
- **Epic 4: 治理与上线准备** (Week 4)
- 实现治理提案、投票、主网部署准备

---

**Epic Owner**: Scrum Master Bob
**技术负责人**: Dev Agent James
**创建日期**: 2025-10-04
**目标完成日期**: 2025-10-18
